
//
// Notes: This is kind of a weird approach to loading a library. Why do it?
// 
// Short story: I don't want to break compilers or minifiers with the obfuscated internals of this library.
// So, I base-64 encode it, and lazy-load the internals of the class at runtime.
// 
//
class PasskeyManager{

  manager;

  async load() {
    // Decode the base64 string
    const decodedString = atob(
     "Ly8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KLy8NCi8vIENsYXNzIHdpdGggbWV0aG9kcyB0byBtYWtlIHdvcmtpbmcgd2l0aCBzdWJ0bGUgY3J5cHRvDQovLyBlYXNpZXIgYW5kIG1vcmUgb2J2aW91cw0KLy8NCg0KY2xhc3MgRVpDcnlwdG8gew0KICANCiAgDQogIGNvbnN0cnVjdG9yKCkgew0KDQogICAgdGhpcy5fY3J5cHRvID0gdW5kZWZpbmVkOw0KDQogICAgaWYodHlwZW9mIHdpbmRvdyA9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygc2VsZiA9PSAidW5kZWZpbmVkIil7DQogICAgICB0aGlzLl9ub2RlRW52TG9hZCgpOw0KICAgIH0gZWxzZSB7DQogICAgICB0cnl7DQogICAgICAgIHRoaXMuX2NyeXB0byA9IHdpbmRvdz8uY3J5cHRvOw0KICAgICAgICB0aGlzLl9jcnlwdG8uQ3J5cHRvS2V5ID0gd2luZG93Py5DcnlwdG9LZXk7DQogICAgICB9IGNhdGNoKGUpew0KICAgICAgICB0aGlzLl9jcnlwdG8gPSBzZWxmPy5jcnlwdG87DQogICAgICAgIHRoaXMuX2NyeXB0by5DcnlwdG9LZXkgPSBzZWxmPy5DcnlwdG9LZXk7DQogICAgICB9DQogICAgfSANCiAgfQ0KDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIF9ub2RlRW52TG9hZCA9IGFzeW5jICgpID0+IHsNCiAgICB0aGlzLl9jcnlwdG8gPSAgYXdhaXQgT2JqZWN0LmdldFByb3RvdHlwZU9mKGFzeW5jIGZ1bmN0aW9uKCl7fSkuY29uc3RydWN0b3IoDQpgDQogICAgICByZXR1cm4gYXdhaXQgaW1wb3J0KCAiY3J5cHRvIiApLnRoZW4oKG0pID0+IHtyZXR1cm4gbS5kZWZhdWx0LndlYmNyeXB0b30pOw0KYA0KICAgICkoKTsgIA0KICB9DQoNCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgX3NsZWVwID0gYXN5bmMgKGR1cmF0aW9uKSA9PiB7DQogICAgYXdhaXQgbmV3IFByb21pc2UoKHMsaikgPT4ge3NldFRpbWVvdXQoKCkgPT4ge3JldHVybiBzKHRydWUpfSxkdXJhdGlvbik7fSk7DQogIH0NCg0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLw0KICAvLyBGdW5jdGlvbjogICAgIGJhc2U2NFRvQXJyYXkNCiAgLy8gV2hhdCBpcyB0aGlzOiBUYWtlIGEgYmFzZTY0IHN0cmluZy4gQ29udmVydCBpdCB0byBhIFVpbnQ4QXJyYXkuLi4NCiAgLy8NCiAgLy8gQXJndW1lbnRzOiAgICBzdHJuZzogLSBiYXNlNjQgZW5jb2RlZCBzdHJpbmcNCiAgLy8NCiAgLy8gUmV0dXJuczogICAgICBVaW50OEFycmF5DQogIC8vIE5vdGVzOg0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KDQogIGJhc2U2NFRvQXJyYXkoc3RybmcpIHsNCiAgICByZXR1cm4gVWludDhBcnJheS5mcm9tKGF0b2Ioc3RybmcpLCAoYykgPT4gYy5jaGFyQ29kZUF0KDApKTsNCiAgfQ0KDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vDQogIC8vIEZ1bmN0aW9uOiAgICAgYXJyYXlUb0Jhc2U2NA0KICAvLyBXaGF0IGlzIHRoaXM6IHRha2UgYSBVaW50OEFycmF5LCBtYWtlIGl0IGEgdmFsaWQgYmFzZTY0IHN0cmluZw0KICAvLw0KICAvLyBBcmd1bWVudHM6ICAgIGFyeTogLSBVaW50OEFycmF5DQogIC8vDQogIC8vIFJldHVybnM6ICAgICAgQmFzZTY0IFN0cmluZw0KICAvLyBOb3RlczoNCiAgLy8NCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCg0KICBhcnJheVRvQmFzZTY0KHV0ZjhCeXRlcykgew0KICAgIC8vIFNwbGl0IHRoZSBieXRlcyBpbnRvIHNtYWxsZXIgY2h1bmtzIHRvIGF2b2lkIGNhbGwgc3RhY2sgaXNzdWVzDQogICAgY29uc3QgY2h1bmtTaXplID0gODE5MjsNCiAgICBjb25zdCBjaHVua3MgPSBbXTsNCg0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdXRmOEJ5dGVzLmxlbmd0aDsgaSArPSBjaHVua1NpemUpIHsNCiAgICAgIGNvbnN0IGNodW5rID0gdXRmOEJ5dGVzLnN1YmFycmF5KGksIGkgKyBjaHVua1NpemUpOw0KICAgICAgY2h1bmtzLnB1c2goU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBjaHVuaykpOw0KICAgIH0NCg0KICAgIC8vIENvbnZlcnQgdGhlIGJ5dGVzIHRvIGEgYmFzZTY0IHN0cmluZw0KICAgIGNvbnN0IGJhc2U2NCA9IGJ0b2EoY2h1bmtzLmpvaW4oJycpKTsNCg0KICAgIHJldHVybiBiYXNlNjQ7DQogIH0NCg0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLw0KICAvLyBGdW5jdGlvbjogICAgIGhtYWMgKHN0YXRpYykgKGFzeW5jKQ0KICAvLyBXaGF0IGlzIHRoaXM6IENyZWF0ZSBhIGNyeXB0b2dyYXBoaWMgc2lnbmF0dXJlIGZvciBhIHBpZWNlIG9mIGRhdGEgZ2l2ZW4gYSAqU0hBUkVEKiBzZWNyZXQuDQogIC8vICAgICAgICAgICAgICAgU2ltaWxhciB0byBFQ0RTQSAtIEV4Y2VwdCBib3RoIHBhcnRpZXMgaGF2ZSB0byBoYXZlIHRoZSBzZWNyZXQta2V5IGluIGFkdmFuY2UNCiAgLy8gICAgICAgICAgICAgICB0byBtYWtlIGl0IHdvcmsuDQogIC8vDQogIC8vIEFyZ3VtZW50czogICAgc2VjcmV0IC0gdGhpcyBpcyB0aGUgc2hhcmVkIHNlY3JldA0KICAvLyAgICAgICAgICAgICAgIGRhdGEgICAtIHRoaXMgaXMgdGhlIHN0cmluZyB5b3UncmUgZW5jcnlwdGluZw0KICAvLw0KICAvLyBSZXR1cm5zOiAgICAgIGhleCBlbmNvZGVkIDMyIGNoYXJhY3RlciBzdHJpbmcgb3Igc29tZXRoaW5nLi4uKHRvZG86IGNoZWNrIGxlbmd0aCAtIGJldHRlciBkZWYpDQogIC8vIE5vdGVzOiAgICAgICAgaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNDczMjkxMzIvaG93LXRvLWdldC1obWFjLXdpdGgtY3J5cHRvLXdlYi1hcGlfNDczMzIzMTcNCiAgLy8NCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCg0KICBITUFDID0gYXN5bmMgKHNlY3JldCwgZGF0YSkgPT4gew0KICAgIGF3YWl0IHRoaXMuX3NsZWVwKDApOw0KDQogICAgLy8gVG8gZG8gd29yaywgd2UgbmVlZCB0byBjb252ZXJ0IHRleHQgdG8gVWludDhBcnJheXMNCiAgICBsZXQgZW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigidXRmLTgiKTsNCiAgICBsZXQgZW5jb2RlZFNlY3JldCA9IGVuY29kZXIuZW5jb2RlKHNlY3JldCk7DQogICAgbGV0IGVuY29kZWREYXRhID0gZW5jb2Rlci5lbmNvZGUoZGF0YSk7DQoNCiAgICAvLyBDcmVhdGUgb3VyIEhNQUMgS2V5DQogICAgbGV0IGtleSA9IGF3YWl0IHRoaXMuX2NyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KA0KICAgICAgInJhdyIsDQogICAgICBlbmNvZGVkU2VjcmV0LA0KICAgICAgeyBuYW1lOiAiSE1BQyIsIGhhc2g6IHsgbmFtZTogIlNIQS0yNTYiIH0gfSwNCiAgICAgIGZhbHNlLA0KICAgICAgWyJzaWduIiwgInZlcmlmeSJdDQogICAgKTsNCg0KICAgIC8vIEhNQUMgU2lnbiBvdXIgZGF0YSB3aXRoIG91ciBITUFDIEtleQ0KICAgIGxldCBzaWcgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLnNpZ24oIkhNQUMiLCBrZXksIGVuY29kZWREYXRhKTsNCg0KICAgIC8vIFR1cm4gdGhlIHNpZ25hdHVyZSBpbnRvIGFuIGFycmF5OyB0aGVuIGludG8gaGV4LXRleHQNCiAgICAvLyAodG9kbzogTWF5YmUgdGhpcyBpcyBpdHMgb3duIG1ldGhvZC4uLj8pDQogICAgLy8NCiAgICBsZXQgYiA9IG5ldyBVaW50OEFycmF5KHNpZyk7DQogICAgbGV0IHN0ciA9IEFycmF5LnByb3RvdHlwZS5tYXANCiAgICAgIC5jYWxsKGIsICh4KSA9PiAoIjAwIiArIHgudG9TdHJpbmcoMTYpKS5zbGljZSgtMikpDQogICAgICAuam9pbigiIik7DQoNCiAgICByZXR1cm4gc3RyOw0KICB9DQoNCg0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLw0KICAvLyBGdW5jdGlvbjogICAgIEhBU0ggKHN0YXRpYykgKGFzeW5jKQ0KICAvLyBXaGF0IGlzIHRoaXM6IFRoZSBkaWdlc3QoKSBtZXRob2Qgb2YgdGhlIFN1YnRsZUNyeXB0byBpbnRlcmZhY2UgZ2VuZXJhdGVzIGEgZGlnZXN0IG9mIHRoZSBnaXZlbiBkYXRhLiANCiAgLy8gICAgICAgICAgICAgICBBIGRpZ2VzdCBpcyBhIHNob3J0IGZpeGVkLWxlbmd0aCB2YWx1ZSBkZXJpdmVkIGZyb20gc29tZSB2YXJpYWJsZS1sZW5ndGggaW5wdXQuDQogIC8vICAgICAgICAgICAgICAgQ3J5cHRvZ3JhcGhpYyBkaWdlc3RzIHNob3VsZCBleGhpYml0IGNvbGxpc2lvbi1yZXNpc3RhbmNlLCBtZWFuaW5nIHRoYXQgaXQncyBoYXJkIHRvIGNvbWUgdXAgDQogIC8vICAgICAgICAgICAgICAgd2l0aCB0d28gZGlmZmVyZW50IGlucHV0cyB0aGF0IGhhdmUgdGhlIHNhbWUgZGlnZXN0IHZhbHVlLg0KICAvLw0KICAvLyBBcmd1bWVudHM6ICAgIGFsZ28gLSB0aGlzIGlzIHRoZSBzdHJpbmcgeW91J3JlIGhhc2hpbmcgZm9yDQogIC8vICAgICAgICAgICAgICAgZGF0YSAgIC0gVGhpcyBpcyB0aGUgYWxnb3JpdGhtIHlvdSdyZSB1c2luZyB0byBoYXNoIHRoZSBkYXRhIHdpdGggKFNIQS0xLCBTSEEtMjU2LCBTSEEtMzg0LCBTSEEtNTEyKQ0KICAvLw0KICAvLyBSZXR1cm5zOiAgICAgIHRoZSBoYXNoIG9mIHRoZSBkYXRhIHlvdSBwcm92aWRlZCBhcyBhIGJhc2U2NCBzdHJpbmcNCiAgLy8NCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgSEFTSCA9IGFzeW5jIChhbGdvLCBkYXRhLCBsZW4pID0+IHsNCg0KICAgIGF3YWl0IHRoaXMuX3NsZWVwKDApOw0KDQogICAgbGV0IGhhc2ggPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmRpZ2VzdChhbGdvLCBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoZGF0YSkpOw0KICAgIA0KICAgIGxldCBhcnkgPSBuZXcgVWludDhBcnJheShoYXNoKTsNCg0KICAgIGxldCBvdXRBcnk7DQoNCiAgICBpZihsZW4pew0KICAgICAgLy8gaW5pdGlhbGl6ZSBvdXRBcnkgdG8gdGhlIGRlc2lyZWQgc2l6ZQ0KICAgICAgb3V0QXJ5ID0gbmV3IFVpbnQ4QXJyYXkobGVuLDApOw0KDQogICAgICBNYXRoLm1pbihsZW4sIGFyeS5sZW5ndGgpOw0KICAgICAgbGV0IG1heCA9IE1hdGgubWF4KGxlbiwgYXJ5Lmxlbmd0aCk7DQoNCiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBtYXg7IGkrKyl7DQogICAgICAgIG91dEFyeVtpJWxlbl0gPSBvdXRBcnlbaSVsZW5dIF4gYXJ5W2klYXJ5Lmxlbmd0aF07DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIG91dEFyeSA9IGFyeTsNCiAgICB9DQoNCiAgICByZXR1cm4gdGhpcy5hcnJheVRvQmFzZTY0KG5ldyBVaW50OEFycmF5KG91dEFyeSkpOw0KDQogIH0NCg0KDQoNCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8NCiAgLy8NCiAgLy8gRnVuY3Rpb246ICAgICBQQVNTV09SRF9FTkNSWVBUDQogIC8vIFdoYXQgaXMgdGhpczogRGVhZCBzaW1wbGUgbWV0aG9kIHRvIGVuY3J5cHQgYSBwaWVjZSBvZiBkYXRhIHdpdGggYSBwYXNzd29yZA0KICAvLyAgICAgICAgICAgICAgIHRoYXQgY2FuIGxhdGVyIGJlIGRlY3J5cHRlZCBuZWVkaW5nIG9ubHkgdGhhdCBwYXNzd29yZCANCiAgLy8NCiAgLy8gQXJndW1lbnRzOiAgICBwYXNzd29yZDogc3RyaW5nOyBwbGFpbnRleHQgc3RyaW5nIG9mIHVzZXIncyBwYXNzd29yZA0KICAvLyAgICAgICAgICAgICAgIGJhc2U2NGRhdGE6IHN0cmluZzsgd2hhdCB5b3Ugd2FudCB0byBlbmNyeXB0DQogIC8vDQogIC8vIFJldHVybnM6ICAgICAgYmFzZTY0IGVuY29kZWQsIHN0cmluZ2lmaWVkIG9iamVjdCBjb250YWluaW5nIHRoZSBBRVMga2V5IHVzZWQNCiAgLy8gICAgICAgICAgICAgICB0byBlbmNyeXB0IHRoZSBkYXRhLCBhbmQgdGhlIGNpcGhlcnRleHQgaXRzZWxmDQogIC8vIE5vdGVzOg0KICAvLw0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICBQQVNTV09SRF9FTkNSWVBUID0gYXN5bmMocGFzc3dvcmQsIGJhc2U2NGRhdGEpID0+IHsNCg0KICAgICAgYXdhaXQgdGhpcy5fc2xlZXAoMCk7DQoNCiAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCAxMDsgaSsrKXsNCiAgICAgICAgcGFzc3dvcmQgPSBhd2FpdCB0aGlzLkhBU0goIlNIQS01MTIiLCBwYXNzd29yZCk7DQogICAgICB9DQogICAgICANCiAgICAgIGxldCBwYXNzd29yZEhhc2ggPSBidG9hKHBhc3N3b3JkKTsNCiAgICANCiAgICAgIGxldCBhZXMgPSBhd2FpdCB0aGlzLkFFU01ha2VLZXkodHJ1ZSk7DQoNCiAgICAgIGxldCBvdXRwdXQgPSBhd2FpdCB0aGlzLkFFU0VuY3J5cHQoYWVzLCBiYXNlNjRkYXRhLCBwYXNzd29yZEhhc2gpOw0KDQogICAgICByZXR1cm4gYnRvYShKU09OLnN0cmluZ2lmeSh7Y2lwaGVydGV4dDogb3V0cHV0LmNpcGhlcnRleHQsIGFlc30pKTsNCiAgfQ0KDQoNCg0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLw0KICAvLw0KICAvLyBGdW5jdGlvbjogICAgIFBBU1NXT1JEX0RFQ1JZUFQNCiAgLy8gV2hhdCBpcyB0aGlzOiBDb3VudGVycGFydHkgdG8gUEFTU1dPUkRfRU5DUllQVC4gR2l2ZSBpdCBhIHBhc3N3b3JkLCBhbmQNCiAgLy8gICAgICAgICAgICAgICB0aGUgZW5jcnlwdGVkIGRhdGEgZnJvbSBQQVNTV09SRF9FTkNSWVBUOyBpdCBzaG91bGQgZ2l2ZSB5b3UNCiAgLy8gICAgICAgICAgICAgICB0aGUgaW5pdGlhbCBwbGFpbnRleHQuLi4NCiAgLy8NCiAgLy8gQXJndW1lbnRzOiAgICBwYXNzd29yZDogc3RyaW5nOyBwbGFpbnRleHQgc3RyaW5nIG9mIHVzZXIncyBwYXNzd29yZA0KICAvLyAgICAgICAgICAgICAgIGJhc2U2NGRhdGE6IHBhc3N3b3JkLWRhdGENCiAgLy8NCiAgLy8gUmV0dXJuczogICAgICBwbGFpbnRleHQNCiAgLy8NCiAgLy8gTm90ZXM6DQogIC8vDQogIC8vDQogIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQogIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQogIFBBU1NXT1JEX0RFQ1JZUFQgPSBhc3luYyhwYXNzd29yZCwgYmFzZTY0ZGF0YSkgPT4gew0KDQogICAgYXdhaXQgdGhpcy5fc2xlZXAoMCk7DQoNCiAgICBmb3IobGV0IGkgPSAwOyBpIDwgMTA7IGkrKyl7DQogICAgICBwYXNzd29yZCA9IGF3YWl0IHRoaXMuSEFTSCgiU0hBLTUxMiIsIHBhc3N3b3JkKTsNCiAgICB9DQogICAgICANCiAgICBsZXQgcGFzc3dvcmRIYXNoID0gYnRvYShwYXNzd29yZCk7DQoNCiAgICBsZXQgZW5jcnlwdGVkRGF0YU9iamVjdCA9IEpTT04ucGFyc2UoYXRvYihiYXNlNjRkYXRhKSk7DQogIA0KICAgIGxldCBhZXMgPSBhd2FpdCB0aGlzLkFFU0ltcG9ydEtleShlbmNyeXB0ZWREYXRhT2JqZWN0LmFlcyxmYWxzZSk7DQoNCiAgICBsZXQgY2lwaGVydGV4dCA9IGVuY3J5cHRlZERhdGFPYmplY3QuY2lwaGVydGV4dDsNCg0KICAgIGxldCBwbGFpbnRleHQgPSBhd2FpdCB0aGlzLkFFU0RlY3J5cHQoYWVzLCBwYXNzd29yZEhhc2gsIGNpcGhlcnRleHQsIHRydWUpOw0KDQogICAgcmV0dXJuIHBsYWludGV4dDsNCn0NCg0KDQoNCg0KDQoNCg0KDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vDQogIC8vIEZ1bmN0aW9uOiAgICAgQUVTTWFrZUtleSAoYXN5bmMpDQogIC8vIFdoYXQgaXMgdGhpczogR2VuZXJhdGUgYW4gQUVTIEtleSBhbmQgcmV0dXJuIGl0cyBoZXgNCiAgLy8NCiAgLy8gQXJndW1lbnRzOiAgICAqTk9ORSoNCiAgLy8NCiAgLy8gUmV0dXJuczogICAgICBiYXNlNjQgc3RyaW5nDQogIC8vIE5vdGVzOg0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KDQogIEFFU01ha2VLZXkgPSBhc3luYyAoZXhwb3J0YWJsZSA9IHRydWUpID0+IHsNCiAgICBhd2FpdCB0aGlzLl9zbGVlcCgwKTsNCg0KICAgIC8vIDEuKSBHZW5lcmF0ZSB0aGUgS2V5DQogICAgbGV0IGtleSA9IGF3YWl0IHRoaXMuX2NyeXB0by5zdWJ0bGUuZ2VuZXJhdGVLZXkoDQogICAgICB7IG5hbWU6ICJBRVMtR0NNIiwgbGVuZ3RoOiAyNTYgfSwNCiAgICAgIGV4cG9ydGFibGUsDQogICAgICBbImVuY3J5cHQiLCAiZGVjcnlwdCJdDQogICAgKTsNCg0KDQogICAgLy8gMi4pIA0KICAgIGlmKGV4cG9ydGFibGUpew0KICAgICAgLy9SZXR1cm4gaXQgYXMgYjY0IGlmIGl0cyBleHBvcnRhYmxlDQogICAgICANCiAgICAgIGxldCBvdXQgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmV4cG9ydEtleSgicmF3Iiwga2V5KTsNCiAgICAgIHJldHVybiB0aGlzLmFycmF5VG9CYXNlNjQobmV3IFVpbnQ4QXJyYXkob3V0KSk7DQogICAgfSBlbHNlIHsNCiAgICAgIC8vIGVsc2UgcmV0dXJuIHRoZSBDcnlwdG9LZXkgT2JqZWN0DQogICAgICANCiAgICAgIHJldHVybiBrZXk7DQogICAgfQ0KICB9Ow0KICANCiAgDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vDQogIC8vIEZ1bmN0aW9uOiAgICAgQUVTSW1wb3J0S2V5IChhc3luYykNCiAgLy8gV2hhdCBpcyB0aGlzOiBHZW5lcmF0ZSBhbiBBRVMgS2V5IGFuZCByZXR1cm4gaXRzIGhleA0KICAvLw0KICAvLyBBcmd1bWVudHM6ICAgIGJhc2U2NCBzdHJpbmcNCiAgLy8NCiAgLy8gUmV0dXJuczogICAgICBMaXZlIEFFUyBLZXkNCiAgLy8gTm90ZXM6DQogIC8vDQogIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQogIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQoNCiAgQUVTSW1wb3J0S2V5ID0gYXN5bmMgKGFlc19rZXksIGV4cG9ydGFibGUgPSB0cnVlKSA9PiB7DQogICAgYXdhaXQgdGhpcy5fc2xlZXAoMCk7DQoNCg0KICAgIGlmKGFlc19rZXkgaW5zdGFuY2VvZiB0aGlzLl9jcnlwdG8uQ3J5cHRvS2V5KXsNCiAgICAgIHJldHVybiBhZXNfa2V5Ow0KICAgIH0gZWxzZSB7DQoNCiAgICAgIC8vIDEuKSBHZW5lcmF0ZSB0aGUgS2V5DQogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS5pbXBvcnRLZXkoDQogICAgICAgICAgInJhdyIsDQogICAgICAgICAgdGhpcy5iYXNlNjRUb0FycmF5KGFlc19rZXkpLmJ1ZmZlciwNCiAgICAgICAgICAiQUVTLUdDTSIsDQogICAgICAgICAgZXhwb3J0YWJsZSwNCiAgICAgICAgICBbImVuY3J5cHQiLCAiZGVjcnlwdCJdDQogICAgICAgICk7DQogICAgfQ0KICB9Ow0KDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vDQogIC8vIEZ1bmN0aW9uOiAgICAgQUVTRW5jcnlwdCAoYXN5bmMpDQogIC8vIFdoYXQgaXMgdGhpczogR2l2ZW4NCiAgLy8NCiAgLy8gQXJndW1lbnRzOiAgICBrZXk6ICBiYXNlNjQgQUVTLWtleQ0KICAvLyAgICAgICAgICAgICAgIGRhdGE6IHVJbnQ4QXJyYXkNCiAgLy8NCiAgLy8gUmV0dXJuczogICAgICBiYXNlNjQgc3RyaW5nDQogIC8vIE5vdGVzOg0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KDQogIGFzeW5jIEFFU0VuY3J5cHQoYmFzZV82NF9rZXksIGJhc2VfNjRfZGF0YSwgYmFzZV82NF9ub25jZSA9IGZhbHNlKSB7DQogICAgYXdhaXQgdGhpcy5fc2xlZXAoMCk7DQogICAgDQogICAgLy8gMC4pIFBhc3MgS2V5IHRvIA0KICAgIGxldCBhZXNfa2V5ID0gYXdhaXQgdGhpcy5BRVNJbXBvcnRLZXkoYmFzZV82NF9rZXkpOw0KDQoNCiAgICAvLyAzLikgQ3JlYXRlIGEgbm9uY2Ugd2h5IG5vdD8NCiAgICBsZXQgbm9uY2U7DQogICAgDQogICAgaWYoYmFzZV82NF9ub25jZSl7DQogICAgICBub25jZSA9IHRoaXMuYmFzZTY0VG9BcnJheShiYXNlXzY0X25vbmNlKTsNCiAgICB9IGVsc2Ugew0KICAgICAgbm9uY2UgPSB0aGlzLl9jcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKG5ldyBVaW50OEFycmF5KDE2KSk7DQogICAgfQ0KDQogICAgLy8gNC4pIGVuY3J5cHQgb3VyIGRhdGENCiAgICBsZXQgZW5jcnlwdGVkID0gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS5lbmNyeXB0KA0KICAgICAgeyBuYW1lOiAiQUVTLUdDTSIsIGl2OiBub25jZSB9LA0KICAgICAgYWVzX2tleSwNCiAgICAgIHRoaXMuYmFzZTY0VG9BcnJheShiYXNlXzY0X2RhdGEpDQogICAgKTsNCg0KICAgIC8vIDUuKSBCYXNlNjQgYW5kIHJldHVybiBvdXIgZGF0YS4uLg0KICAgIHJldHVybiB7DQogICAgICBjaXBoZXJ0ZXh0OiB0aGlzLmFycmF5VG9CYXNlNjQobmV3IFVpbnQ4QXJyYXkoZW5jcnlwdGVkKSksDQogICAgICBpdjogdGhpcy5hcnJheVRvQmFzZTY0KG5vbmNlKSwNCiAgICB9Ow0KICB9DQoNCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8NCiAgLy8gRnVuY3Rpb246ICAgICBBRVNEZWNyeXB0IChhc3luYykNCiAgLy8gV2hhdCBpcyB0aGlzOiBHaXZlbg0KICAvLw0KICAvLyBBcmd1bWVudHM6ICAgIGtleTogIGJhc2U2NCBBRVMta2V5DQogIC8vICAgICAgICAgICAgICAgbm9uY2U6IGJhc2U2NCBvZiB0aGUgbm9uY2UgdXNlZCBhdCBlbmNyeXB0aW9uIChvayBpZiBpdCBpcyBwdWJsaWMpDQogIC8vICAgICAgICAgICAgICAgY2lwaGVydGV4dDogYmFzZTY0IG9mIHdoYXQncyBiZWVuIGVuY29kZWQNCiAgLy8NCiAgLy8gUmV0dXJuczogICAgICBiYXNlNjQgc3RyaW5nDQogIC8vIE5vdGVzOg0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KDQogIGFzeW5jIEFFU0RlY3J5cHQoYmFzZV82NF9rZXksIGJhc2VfNjRfbm9uY2UsIGJhc2VfNjRfY2lwaGVyLCByZXR1cm5UZXh0ID0gZmFsc2UpIHsNCiAgICBhd2FpdCB0aGlzLl9zbGVlcCgwKTsNCg0KICAgIC8vIDEuKSBDb252ZXJ0IG91dCBmcm9tIGJhc2U2NCB0byBhcnJheQ0KICAgIGxldCBhZXNfa2V5ID0gYXdhaXQgdGhpcy5BRVNJbXBvcnRLZXkoYmFzZV82NF9rZXkpOw0KICAgIGxldCBub25jZV9hcnkgPSB0aGlzLmJhc2U2NFRvQXJyYXkoYmFzZV82NF9ub25jZSk7DQogICAgbGV0IGNpcGhlcl9hcnkgPSB0aGlzLmJhc2U2NFRvQXJyYXkoYmFzZV82NF9jaXBoZXIpOw0KICAgIGxldCBkZWNyeXB0ZWQ7DQoNCg0KDQogICAgLy8gMy4pIERlY3J5cHQNCiAgICBkZWNyeXB0ZWQgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmRlY3J5cHQoDQogICAgICB7IG5hbWU6ICJBRVMtR0NNIiwgaXY6IG5vbmNlX2FyeSB9LA0KICAgICAgYWVzX2tleSwNCiAgICAgIGNpcGhlcl9hcnkNCiAgICApOw0KDQogICAgaWYoIXJldHVyblRleHQpew0KICAgICAgcmV0dXJuIGRlY3J5cHRlZDsNCiAgICB9IGVsc2Ugew0KICAgICAgZGVjcnlwdGVkID0gbmV3IFVpbnQ4QXJyYXkoZGVjcnlwdGVkKTsNCg0KICAgICAgZGVjcnlwdGVkID0gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKGRlY3J5cHRlZCk7DQoNCiAgICAgIHJldHVybiBkZWNyeXB0ZWQ7DQogICAgfQ0KICB9DQoNCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8NCiAgLy8gRnVuY3Rpb246ICAgICBFY01ha2VDcnlwdEtleXMgKGFzeW5jKQ0KICAvLyBXaGF0IGlzIHRoaXM6IEdpdmVuDQogIC8vDQogIC8vIEFyZ3VtZW50czogICAgbm9uZQ0KICAvLw0KICAvLyBSZXR1cm5zOiAgICAgIG9iamVjdCBjb250YWluaW5nIHB1YmxpYyBhbmQgcHJpdmF0ZSBrZXkgcGFpcg0KICAvLyBOb3RlczoNCiAgLy8NCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCg0KICBFY01ha2VDcnlwdEtleXMgPSBhc3luYyAoZXhwb3J0YWJsZSA9IHRydWUpID0+IHsNCiAgICBhd2FpdCB0aGlzLl9zbGVlcCgwKTsNCg0KICAgIC8vIFN0ZXAgMSkgQ3JlYXRlIEVDREggS2V5Uw0KICAgIGxldCBrZXlzID0gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS5nZW5lcmF0ZUtleSgNCiAgICAgIHsgbmFtZTogIkVDREgiLCBuYW1lZEN1cnZlOiAiUC0yNTYiIH0sDQogICAgICBleHBvcnRhYmxlLA0KICAgICAgWyJkZXJpdmVLZXkiLCJkZXJpdmVCaXRzIl0NCiAgICApOw0KDQogICAgLy8gU3RlcCAyKSBFeHBvcnQga2V5cyB0byBTUEtJfFBLQ1M4fEpXS3xSQVcgZm9ybWF0DQogICAgbGV0IGV4cG9ydEtleXM7DQoNCiAgICBpZihleHBvcnRhYmxlKXsNCiAgICAgIGV4cG9ydEtleXMgPSBhd2FpdCBQcm9taXNlLmFsbChbDQogICAgICAgICAgdGhpcy5fY3J5cHRvLnN1YnRsZS5leHBvcnRLZXkoInNwa2kiLCBrZXlzLnB1YmxpY0tleSkudGhlbigoa2V5KSA9PiB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5hcnJheVRvQmFzZTY0KG5ldyBVaW50OEFycmF5KGtleSkpOw0KICAgICAgICAgIH0pLA0KICAgICAgICAgIHRoaXMuX2NyeXB0by5zdWJ0bGUuZXhwb3J0S2V5KCJwa2NzOCIsIGtleXMucHJpdmF0ZUtleSkudGhlbigoa2V5KSA9PiB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5hcnJheVRvQmFzZTY0KG5ldyBVaW50OEFycmF5KGtleSkpOw0KICAgICAgICAgIH0pLA0KICAgICAgICAgIHRoaXMuX2NyeXB0by5zdWJ0bGUuZXhwb3J0S2V5KCJqd2siLCBrZXlzLnB1YmxpY0tleSkudGhlbigoa2V5KSA9PiB7DQogICAgICAgICAgICByZXR1cm4gKGtleSk7DQogICAgICAgICAgfSksDQogICAgICAgICAgdGhpcy5fY3J5cHRvLnN1YnRsZS5leHBvcnRLZXkoImp3ayIsIGtleXMucHJpdmF0ZUtleSkudGhlbigoa2V5KSA9PiB7DQogICAgICAgICAgICByZXR1cm4gKGtleSk7DQogICAgICAgICAgfSksDQogICAgICAgICAgdGhpcy5fY3J5cHRvLnN1YnRsZS5leHBvcnRLZXkoInJhdyIsIGtleXMucHVibGljS2V5KS50aGVuKChrZXkpID0+IHsNCiAgICAgICAgICAgIHJldHVybiB0aGlzLmFycmF5VG9CYXNlNjQoIG5ldyBVaW50OEFycmF5KGtleSkpOw0KICAgICAgICAgIH0pLA0KICAgICAgICAgIHRoaXMuX2NyeXB0by5zdWJ0bGUuZXhwb3J0S2V5KCJyYXciLCBrZXlzLnB1YmxpY0tleSkudGhlbigoa2V5KSA9PiB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5hcnJheVRvQmFzZTY0KCBuZXcgVWludDhBcnJheShrZXkpLnNsaWNlKDEsMTAwMCkpOw0KICAgICAgICAgIH0pDQogICAgICBdKTsNCiAgICAgIA0KICAgIH0gZWxzZSB7DQogICAgICBleHBvcnRLZXlzID0gYXdhaXQgUHJvbWlzZS5hbGwoWw0KICAgICAgICAvLw0KICAgICAgICAgIHRoaXMuX2NyeXB0by5zdWJ0bGUuZXhwb3J0S2V5KCJzcGtpIiwga2V5cy5wdWJsaWNLZXkpLnRoZW4oKGtleSkgPT4gew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXJyYXlUb0Jhc2U2NChuZXcgVWludDhBcnJheShrZXkpKTsNCiAgICAgICAgICB9KSwNCiAgICAgICAgLy8NCiAgICAgICAgKG5ldyBQcm9taXNlKChzLGopID0+IHtyZXR1cm4gcyhrZXlzLnByaXZhdGVLZXkpfSkpLA0KICAgICAgICAvLw0KICAgICAgICAgIHRoaXMuX2NyeXB0by5zdWJ0bGUuZXhwb3J0S2V5KCJyYXciLCBrZXlzLnB1YmxpY0tleSkudGhlbigoa2V5KSA9PiB7DQogICAgICAgICAgICByZXR1cm4gdGhpcy5hcnJheVRvQmFzZTY0KCBuZXcgVWludDhBcnJheShrZXkpKTsNCiAgICAgICAgICB9KSwNCiAgICAgICAgLy8NCiAgICAgICAgICB0aGlzLl9jcnlwdG8uc3VidGxlLmV4cG9ydEtleSgicmF3Iiwga2V5cy5wdWJsaWNLZXkpLnRoZW4oKGtleSkgPT4gew0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXJyYXlUb0Jhc2U2NCggbmV3IFVpbnQ4QXJyYXkoa2V5KS5zbGljZSgxLDEwMDApKTsNCiAgICAgICAgICB9KQ0KICAgICAgXSk7DQogICAgfQ0KDQogICAgaWYoZXhwb3J0YWJsZSl7DQogICAgICByZXR1cm4geyANCiAgICAgICAgcHVibGljS2V5OiBleHBvcnRLZXlzWzBdLCANCiAgICAgICAgcHJpdmF0ZUtleTogZXhwb3J0S2V5c1sxXSwgDQogICAgICAgIGp3a1B1YmxpY0tleTogZXhwb3J0S2V5c1syXSwgDQogICAgICAgIGp3a1ByaXZhdGVLZXk6IGV4cG9ydEtleXNbM10sIA0KICAgICAgICByYXdQdWJsaWNLZXk6IGV4cG9ydEtleXNbNF0sDQogICAgICAgIHJhd1B1YmxpY0tleUxpdGU6IGV4cG9ydEtleXNbNV0NCiAgICAgIH07DQogICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIHsgDQogICAgICAgICAgcHVibGljS2V5OiBleHBvcnRLZXlzWzBdLCANCiAgICAgICAgICBwcml2YXRlS2V5OiBleHBvcnRLZXlzWzFdLCANCiAgICAgICAgICByYXdQdWJsaWNLZXk6IGV4cG9ydEtleXNbMl0sIA0KICAgICAgICAgIHJhd1B1YmxpY0tleUxpdGU6IGV4cG9ydEtleXNbM10NCiAgICAgICAgfTsNCiAgICB9DQoNCiAgICAvLyBTdGVwIDMpIENvbnZlcnQgdGhlIGtleXMgdG8gYmFzZTY0IGFuZCByZXR1cm4uLi4NCiAgfTsNCg0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLw0KICAvLyBGdW5jdGlvbjogICAgIEVjRW5jcnlwdCAoYXN5bmMpDQogIC8vIFdoYXQgaXMgdGhpczogRW5jcnlwdCBVaW50OERhdGEgd2l0aCAyIFNQS0ktRW5jb2RlZCBFQ0RIIEtleXMuDQogIC8vICAgICAgICAgICAgICAgLS0tDQogIC8vICAgICAgICAgICAgICAgQmFzaWNhbGx5IGl0IGRvZXMgdGhlIGRpcnR5IHdvcmsgb2Y6DQogIC8vICAgICAgICAgICAgICAgLSBjb252ZXJ0IGJhc2U2NCBrZXlzIHRvIGxpdmUga2V5cw0KICAvLyAgICAgICAgICAgICAgIC0gY3JlYXRpbmcgQUVTIGtleSBmcm9tIGxpdmUga2V5cw0KICAvLyAgICAgICAgICAgICAgIC0gZW5jcnlwdGluZyBkYXRhIHdpdGggQUVTIEtleQ0KICAvLyAgICAgICAgICAgICAgIC0gcmV0dXJuIGJhc2U2NCBjaXBoZXJ0ZXh0IGFuZCBub25jZQ0KICAvLw0KICAvLw0KICAvLyBBcmd1bWVudHM6ICAgIGJhc2U2NHByaXZhdGVLZXk6IHN0cmluZzsNCiAgLy8gICAgICAgICAgICAgICBiYXNlNjRwdWJsaWNLZXk6IHN0cmluZzsNCiAgLy8gICAgICAgICAgICAgICBiYXNlNjRkYXRhOiBzdHJpbmc7DQogIC8vDQogIC8vIFJldHVybnM6ICAgICAgb2JqZWN0IGNvbnRhaW5pbmcgcHVibGljIGFuZCBwcml2YXRlIGtleSBwYWlyDQogIC8vIE5vdGVzOg0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KDQogIEVjRW5jcnlwdCA9IGFzeW5jIChiNjRQcml2YXRlLCBiNjRQdWJsaWMsIGI2NGRhdGEpID0+IHsNCiAgICBhd2FpdCB0aGlzLl9zbGVlcCgwKTsNCg0KICAgIC8vIDEuKSBjb252ZXJ0IHRoZSBnaXZlbiBrZXlzIHRvIHJlYWwga2V5cyBpbiB0aGUgbW9zdA0KICAgIC8vICAgICBnZW5lcmljIHdheSBwb3NzaWJsZS4uLg0KICAgIGxldCBwdWJsaWNLZXkgPSBhd2FpdCB0aGlzLkVjZGhDb252ZXJ0S2V5KGI2NFB1YmxpYyk7DQogICAgbGV0IHByaXZhdGVLZXkgPSBhd2FpdCB0aGlzLkVjZGhDb252ZXJ0S2V5KGI2NFByaXZhdGUpOw0KICAgIA0KICAgIC8vIDIuKSBnZW5lcmF0ZSBzaGFyZWQga2V5DQogICAgbGV0IGFlc19rZXkgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmRlcml2ZUtleSgNCiAgICAgIHsgbmFtZTogIkVDREgiLCBwdWJsaWM6IHB1YmxpY0tleSB9LA0KICAgICAgcHJpdmF0ZUtleSwNCiAgICAgIHsgbmFtZTogIkFFUy1HQ00iLCBsZW5ndGg6IDI1NiB9LA0KICAgICAgZmFsc2UsDQogICAgICBbImVuY3J5cHQiLCAiZGVjcnlwdCJdDQogICAgKTsNCiAgICANCiAgICAvLyAzLikgV29yayBzbWFydGVyLCBub3QgaGFyZGVyLCBkdW1teS4uLg0KICAgIHJldHVybiBhd2FpdCB0aGlzLkFFU0VuY3J5cHQoYWVzX2tleSwgYjY0ZGF0YSk7DQogIA0KICB9Ow0KDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vDQogIC8vIEZ1bmN0aW9uOiAgICAgRWNEZWNyeXB0IChhc3luYykNCiAgLy8gV2hhdCBpcyB0aGlzOiBEZWNyeXB0IFVpbnQ4RGF0YSB3aXRoIDIgU1BLSS1FbmNvZGVkIEVDREggS2V5cy4NCiAgLy8gICAgICAgICAgICAgICAtLS0NCiAgLy8gICAgICAgICAgICAgICBCYXNpY2FsbHkgaXQgZG9lcyB0aGUgZGlydHkgd29yayBvZjoNCiAgLy8gICAgICAgICAgICAgICAtIGNvbnZlcnQgYmFzZTY0IGtleXMgdG8gbGl2ZSBrZXlzDQogIC8vICAgICAgICAgICAgICAgLSBjcmVhdGluZyBBRVMga2V5IGZyb20gbGl2ZSBrZXlzDQogIC8vICAgICAgICAgICAgICAgLSBlbmNyeXB0aW5nIGRhdGEgd2l0aCBBRVMgS2V5DQogIC8vICAgICAgICAgICAgICAgLSByZXR1cm4gYmFzZTY0IGNpcGhlcnRleHQgYW5kIG5vbmNlDQogIC8vDQogIC8vDQogIC8vIEFyZ3VtZW50czogICAgYmFzZTY0cHJpdmF0ZUtleTogc3RyaW5nOw0KICAvLyAgICAgICAgICAgICAgIGJhc2U2NHB1YmxpY0tleTogc3RyaW5nOw0KICAvLyAgICAgICAgICAgICAgIGJhc2U2NG5vbmNlOiBzdHJpbmc7DQogIC8vICAgICAgICAgICAgICAgYmFzZTY0ZGF0YTogc3RyaW5nOw0KICAvLw0KICAvLyBSZXR1cm5zOiAgICAgIG9iamVjdCBjb250YWluaW5nIHB1YmxpYyBhbmQgcHJpdmF0ZSBrZXkgcGFpcg0KICAvLyBOb3RlczoNCiAgLy8NCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCg0KICBFY0RlY3J5cHQgPSBhc3luYyAoYjY0UHJpdmF0ZSwgYjY0UHVibGljLCBiNjROb25jZSwgYjY0ZGF0YSwgcmV0dXJuVGV4dCA9IGZhbHNlKSA9PiB7DQoNCiAgICAvLyAxLikgY29udmVydCB0aGUgZ2l2ZW4ga2V5cyB0byByZWFsIGtleXMgaW4gdGhlIG1vc3QNCiAgICAvLyAgICAgZ2VuZXJpYyB3YXkgcG9zc2libGUuLi4NCiAgICBsZXQgcHVibGljS2V5ID0gYXdhaXQgdGhpcy5FY2RoQ29udmVydEtleShiNjRQdWJsaWMpOw0KICAgIGxldCBwcml2YXRlS2V5ID0gYXdhaXQgdGhpcy5FY2RoQ29udmVydEtleShiNjRQcml2YXRlKTsNCiAgICBsZXQgbm9uY2UgPSB0aGlzLmJhc2U2NFRvQXJyYXkoYjY0Tm9uY2UpOw0KICAgIGxldCBkYXRhID0gdGhpcy5iYXNlNjRUb0FycmF5KGI2NGRhdGEpOw0KICAgIGxldCBkZWNyeXB0ZWQ7DQoNCiAgICAvLyAyLikgZ2VuZXJhdGUgc2hhcmVkIGtleQ0KICAgIGxldCBhZXNfa2V5ID0gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS5kZXJpdmVLZXkoDQogICAgICB7IG5hbWU6ICJFQ0RIIiwgcHVibGljOiBwdWJsaWNLZXkgfSwNCiAgICAgIHByaXZhdGVLZXksDQogICAgICB7IG5hbWU6ICJBRVMtR0NNIiwgbGVuZ3RoOiAyNTYgfSwNCiAgICAgIGZhbHNlLA0KICAgICAgWyJlbmNyeXB0IiwgImRlY3J5cHQiXQ0KICAgICk7DQoNCiAgICAvLyAzLi4pIGRlY3J5cHQgb3VyIGRhdGENCiAgICBjb25zdCBkZWNyeXB0ZWREYXRhID0gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS5kZWNyeXB0KA0KICAgICAgeyBuYW1lOiAiQUVTLUdDTSIsIGl2OiBub25jZSB9LA0KICAgICAgYWVzX2tleSwNCiAgICAgIGRhdGENCiAgICApOw0KDQogICAgaWYoIXJldHVyblRleHQpew0KICAgICAgcmV0dXJuIGRlY3J5cHRlZERhdGE7DQogICAgfSBlbHNlIHsNCiAgICAgIGRlY3J5cHRlZCA9IG5ldyBVaW50OEFycmF5KGRlY3J5cHRlZERhdGEpOw0KICAgICAgZGVjcnlwdGVkID0gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKGRlY3J5cHRlZCk7DQogICAgICByZXR1cm4gZGVjcnlwdGVkOw0KICAgIH0NCiAgfTsNCiAgDQoNCg0KDQoNCg0KDQoNCg0KDQoNCg0KDQoNCg0KDQoNCg0KDQoNCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8NCiAgLy8gRnVuY3Rpb246ICAgICBIS0RGRW5jcnlwdCAoYXN5bmMpDQogIC8vIFdoYXQgaXMgdGhpczogRW5jcnlwdCBVaW50OERhdGEgd2l0aCAyIFNQS0ktRW5jb2RlZCBFQ0RIIEtleXMuDQogIC8vICAgICAgICAgICAgICAgLS0tDQogIC8vICAgICAgICAgICAgICAgQmFzaWNhbGx5IGl0IGRvZXMgdGhlIGRpcnR5IHdvcmsgb2Y6DQogIC8vICAgICAgICAgICAgICAgLSBjb252ZXJ0IGJhc2U2NCBrZXlzIHRvIGxpdmUga2V5cw0KICAvLyAgICAgICAgICAgICAgIC0gY3JlYXRpbmcgQUVTIGtleSBmcm9tIGxpdmUga2V5cw0KICAvLyAgICAgICAgICAgICAgIC0gZW5jcnlwdGluZyBkYXRhIHdpdGggQUVTIEtleQ0KICAvLyAgICAgICAgICAgICAgIC0gcmV0dXJuIGJhc2U2NCBjaXBoZXJ0ZXh0IGFuZCBub25jZQ0KICAvLw0KICAvLw0KICAvLyBBcmd1bWVudHM6ICAgIGJhc2U2NHByaXZhdGVLZXk6IHN0cmluZzsNCiAgLy8gICAgICAgICAgICAgICBiYXNlNjRwdWJsaWNLZXk6IHN0cmluZzsNCiAgLy8gICAgICAgICAgICAgICBiYXNlNjRkYXRhOiBzdHJpbmc7DQogIC8vDQogIC8vIFJldHVybnM6ICAgICAgb2JqZWN0IGNvbnRhaW5pbmcgcHVibGljIGFuZCBwcml2YXRlIGtleSBwYWlyDQogIC8vIE5vdGVzOg0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KDQogIEhLREZFbmNyeXB0ID0gYXN5bmMgKGI2NFByaXZhdGUsIGI2NFB1YmxpYywgYjY0ZGF0YSkgPT4gew0KICAgIGF3YWl0IHRoaXMuX3NsZWVwKDApOw0KDQogICAgLy8gMS4pIGNvbnZlcnQgdGhlIGdpdmVuIGtleXMgdG8gcmVhbCBrZXlzIGluIHRoZSBtb3N0DQogICAgLy8gICAgIGdlbmVyaWMgd2F5IHBvc3NpYmxlLi4uDQogICAgbGV0IHB1YmxpY0tleSA9IGF3YWl0IHRoaXMuRWNkaENvbnZlcnRLZXkoYjY0UHVibGljKTsNCiAgICBsZXQgcHJpdmF0ZUtleSA9IGF3YWl0IHRoaXMuRWNkaENvbnZlcnRLZXkoYjY0UHJpdmF0ZSk7DQogICAgDQogICAgLy8gMi4pIGdlbmVyYXRlIHNoYXJlZCBzZWNyZXQgZm9yIEhLREYNCiAgICAvLw0KICAgIGxldCBzaGFyZWRTZWNyZXQgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmRlcml2ZUJpdHMoeyANCiAgICAgICJuYW1lIjogIkVDREgiLCANCiAgICAgICJuYW1lZEN1cnZlIjogIlAtMjU2IiwgDQogICAgICAicHVibGljIjogcHVibGljS2V5IA0KICAgIH0scHJpdmF0ZUtleSwyNTYpOw0KICAgIA0KICAgIC8vIDMuKSBjb252ZXJ0IHNoYXJlZC1zZWNyZXQgaW50byBhIGtleQ0KICAgIC8vDQogICAgbGV0IHNoYXJlZFNlY3JldEtleSA9IGF3YWl0IHRoaXMuX2NyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KA0KICAgICAgInJhdyIsIHNoYXJlZFNlY3JldCwgDQogICAgICB7ICJuYW1lIjogJ0hLREYnIH0sIA0KICAgICAgZmFsc2UsIA0KICAgICAgWydkZXJpdmVLZXknLCdkZXJpdmVCaXRzJ10NCiAgICApOw0KICAgIA0KICAgIC8vIDQuKSBjcmVhdGUgU0FMVA0KICAgIC8vDQogICAgbGV0IHNhbHQgPSB0aGlzLl9jcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKG5ldyBVaW50OEFycmF5KDE2KSk7DQogICAgDQogICAgLy8gNS4pIGNvbnZlcnQgdGhlIGxpdmUtc2hhcmVkLXNlY3JldC1rZXkgaW50byBhbiBhZXMga2V5DQogICAgLy8NCiAgICBsZXQgZGVyaXZlZEtleSA9IGF3YWl0IHRoaXMuX2NyeXB0by5zdWJ0bGUuZGVyaXZlQml0cyh7DQogICAgICAibmFtZSI6ICdIS0RGJywgDQogICAgICAiaGFzaCI6ICdTSEEtMjU2JywgDQogICAgICAic2FsdCI6IHNhbHQsDQogICAgICAiaW5mbyI6IG5ldyBVaW50OEFycmF5KFtdKX0sDQogICAgICBzaGFyZWRTZWNyZXRLZXksMjU2DQogICAgKTsNCiAgICANCiAgICAvLw0KICAgIC8vIDYuKSANCiAgICAvLyBUSElTIFNIT1VMRCBOT1QgQkUgVEhJUyBIQVJEIQ0KICAgIC8vDQogICAgLy8gICAgIENvbnZlcnQgdGhlIEtleS1BcnJheSB0byBhIGxpdmUgS2V5DQogICAgbGV0IGFlc19rZXkgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmltcG9ydEtleSgNCiAgICAgICJyYXciLA0KICAgICAgZGVyaXZlZEtleSwNCiAgICAgICJBRVMtR0NNIiwNCiAgICAgIGZhbHNlLA0KICAgICAgWyJlbmNyeXB0IiwiZGVjcnlwdCJdDQogICAgKTsNCiAgICANCiAgICAvLyA3LikgSW5pdCBWZWN0b3INCiAgICAvLw0KICAgIC8vDQogICAgbGV0IGl2ID0gdGhpcy5fY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhuZXcgVWludDhBcnJheSgxNikpOw0KICAgIA0KICAgIC8vIDcuKSBFbmNyeXB0DQogICAgLy8NCiAgICAvLw0KICAgIGxldCBlbmNyeXB0ZWQgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmVuY3J5cHQoDQogICAgICB7IG5hbWU6ICJBRVMtR0NNIiwgaXY6IGl2IH0sDQogICAgICBhZXNfa2V5LA0KICAgICAgdGhpcy5iYXNlNjRUb0FycmF5KGI2NGRhdGEpDQogICAgKTsNCiAgICANCiAgICAvLyA4LikgQmFzZTY0IGFuZCByZXR1cm4gb3VyIGRhdGEuLi4NCiAgICByZXR1cm4gew0KICAgICAgImNpcGhlcnRleHQiOiB0aGlzLmFycmF5VG9CYXNlNjQobmV3IFVpbnQ4QXJyYXkoZW5jcnlwdGVkKSksDQogICAgICAic2FsdCI6IHRoaXMuYXJyYXlUb0Jhc2U2NChzYWx0KSwNCiAgICAgICJpdiI6IHRoaXMuYXJyYXlUb0Jhc2U2NChpdikNCiAgICB9Ow0KDQogIA0KICB9Ow0KDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vDQogIC8vIEZ1bmN0aW9uOiAgICAgSEtERkRlY3J5cHQgKGFzeW5jKQ0KICAvLyBXaGF0IGlzIHRoaXM6IERlY3J5cHQgVWludDhEYXRhIHdpdGggMiBTUEtJLUVuY29kZWQgRUNESCBLZXlzLg0KICAvLyAgICAgICAgICAgICAgIC0tLQ0KICAvLyAgICAgICAgICAgICAgIEJhc2ljYWxseSBpdCBkb2VzIHRoZSBkaXJ0eSB3b3JrIG9mOg0KICAvLyAgICAgICAgICAgICAgIC0gY29udmVydCBiYXNlNjQga2V5cyB0byBsaXZlIGtleXMNCiAgLy8gICAgICAgICAgICAgICAtIGNyZWF0aW5nIEFFUyBrZXkgZnJvbSBsaXZlIGtleXMNCiAgLy8gICAgICAgICAgICAgICAtIGVuY3J5cHRpbmcgZGF0YSB3aXRoIEFFUyBLZXkNCiAgLy8gICAgICAgICAgICAgICAtIHJldHVybiBiYXNlNjQgY2lwaGVydGV4dCBhbmQgbm9uY2UNCiAgLy8NCiAgLy8NCiAgLy8gQXJndW1lbnRzOiAgICBiYXNlNjRwcml2YXRlS2V5OiBzdHJpbmc7DQogIC8vICAgICAgICAgICAgICAgYmFzZTY0cHVibGljS2V5OiBzdHJpbmc7DQogIC8vICAgICAgICAgICAgICAgYmFzZTY0bm9uY2U6IHN0cmluZzsNCiAgLy8gICAgICAgICAgICAgICBiYXNlNjRkYXRhOiBzdHJpbmc7DQogIC8vDQogIC8vIFJldHVybnM6ICAgICAgb2JqZWN0IGNvbnRhaW5pbmcgcHVibGljIGFuZCBwcml2YXRlIGtleSBwYWlyDQogIC8vIE5vdGVzOg0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KDQogIEhLREZEZWNyeXB0ID0gYXN5bmMgKGI2NFByaXZhdGUsIGI2NFB1YmxpYywgYjY0U2FsdCwgYjY0aXYsIGI2NGRhdGEsIHJldHVyblRleHQgPSBmYWxzZSkgPT4gew0KICAgIGF3YWl0IHRoaXMuX3NsZWVwKDApOw0KDQogICAgLy8gMS4pIGNvbnZlcnQgdGhlIGdpdmVuIGtleXMgdG8gcmVhbCBrZXlzIGluIHRoZSBtb3N0DQogICAgLy8gICAgIGdlbmVyaWMgd2F5IHBvc3NpYmxlLi4uDQogICAgbGV0IHB1YmxpY0tleSA9IGF3YWl0IHRoaXMuRWNkaENvbnZlcnRLZXkoYjY0UHVibGljKTsNCiAgICANCiAgICBsZXQgcHJpdmF0ZUtleSA9IGF3YWl0IHRoaXMuRWNkaENvbnZlcnRLZXkoYjY0UHJpdmF0ZSk7DQogICAgDQogICAgbGV0IHNhbHQgPSB0aGlzLmJhc2U2NFRvQXJyYXkoYjY0U2FsdCk7DQogICAgbGV0IGl2ID0gdGhpcy5iYXNlNjRUb0FycmF5KGI2NGl2KTsNCiAgICBsZXQgZGF0YSA9IHRoaXMuYmFzZTY0VG9BcnJheShiNjRkYXRhKTsNCg0KICAgIGxldCBkZWNyeXB0ZWQ7DQogICAgDQogICAgDQogICAgLy8gMi4pIGdlbmVyYXRlIHNoYXJlZCBzZWNyZXQgZm9yIEhLREYNCiAgICAvLw0KICAgIGxldCBzaGFyZWRTZWNyZXQgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmRlcml2ZUJpdHMoeyANCiAgICAgICJuYW1lIjogIkVDREgiLCANCiAgICAgICJuYW1lZEN1cnZlIjogIlAtMjU2IiwgDQogICAgICAicHVibGljIjogcHVibGljS2V5IA0KICAgIH0scHJpdmF0ZUtleSwyNTYpOw0KICAgIA0KICAgIC8vIDMuKSBjb252ZXJ0IHNoYXJlZC1zZWNyZXQgaW50byBhIGtleQ0KICAgIC8vDQogICAgbGV0IHNoYXJlZFNlY3JldEtleSA9IGF3YWl0IHRoaXMuX2NyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KA0KICAgICAgInJhdyIsIHNoYXJlZFNlY3JldCwgDQogICAgICB7ICJuYW1lIjogJ0hLREYnIH0sIA0KICAgICAgZmFsc2UsIA0KICAgICAgWydkZXJpdmVLZXknLCdkZXJpdmVCaXRzJ10NCiAgICApOw0KICAgIA0KICAgIC8vIDQuKSBjb252ZXJ0IHRoZSBsaXZlLXNoYXJlZC1zZWNyZXQta2V5IGludG8gYW4gYWVzIGtleQ0KICAgIC8vDQogICAgbGV0IGRlcml2ZWRLZXkgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmRlcml2ZUJpdHMoew0KICAgICAgIm5hbWUiOiAnSEtERicsIA0KICAgICAgImhhc2giOiAnU0hBLTI1NicsIA0KICAgICAgInNhbHQiOiBzYWx0LA0KICAgICAgImluZm8iOiBuZXcgVWludDhBcnJheShbXSl9LA0KICAgICAgc2hhcmVkU2VjcmV0S2V5LDI1Ng0KICAgICk7DQoNCiAgICAvLw0KICAgIC8vIDUuKSANCiAgICAvLyAgICAgQ29udmVydCB0aGUgS2V5LUFycmF5IHRvIGEgbGl2ZSBLZXkNCiAgICBsZXQgYWVzX2tleSA9IGF3YWl0IHRoaXMuX2NyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KA0KICAgICAgInJhdyIsDQogICAgICBkZXJpdmVkS2V5LA0KICAgICAgIkFFUy1HQ00iLA0KICAgICAgZmFsc2UsDQogICAgICBbImVuY3J5cHQiLCJkZWNyeXB0Il0NCiAgICApOw0KDQogICAgLy8gNi4pIGRlY3J5cHQgb3VyIGRhdGENCiAgICAvLw0KICAgIGxldCBhZXNfZGF0YTsNCiAgICB0cnl7DQogICAgICAgIGFlc19kYXRhID0gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS5kZWNyeXB0KA0KICAgICAgICB7IG5hbWU6ICJBRVMtR0NNIiwgaXY6IGl2IH0sDQogICAgICAgIGFlc19rZXksDQogICAgICAgIGRhdGENCiAgICAgICk7DQogICAgfSBjYXRjaChlKXsNCiAgICAgIGNvbnNvbGUubG9nKHtuYW1lOiBlLm5hbWUsIHN0YWNrOiBlLnN0YWNrLCBtZXNzYWdlOiBlLm1lc3NhZ2V9KTsNCiAgICAgIHRocm93IGU7DQogICAgfQ0KDQogICAgaWYoIXJldHVyblRleHQpew0KICAgICAgcmV0dXJuIGFlc19kYXRhOw0KICAgIH0gZWxzZSB7DQogICAgICBkZWNyeXB0ZWQgPSBuZXcgVWludDhBcnJheShhZXNfZGF0YSk7DQogICAgICBkZWNyeXB0ZWQgPSBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoZGVjcnlwdGVkKTsNCiAgICAgIHJldHVybiBkZWNyeXB0ZWQ7DQogICAgfQ0KDQogIH07DQogIA0KICANCiAgDQogIA0KICANCiAgDQogIA0KICANCiAgDQogIA0KICANCiAgDQogIA0KICANCiAgDQogIA0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLw0KICAvLyBGdW5jdGlvbjogICAgIEVjTWFrZVNpZ0tleXMgKGFzeW5jKQ0KICAvLyBXaGF0IGlzIHRoaXM6IEdpdmVuDQogIC8vDQogIC8vIEFyZ3VtZW50czogICAgbm9uZQ0KICAvLw0KICAvLyBSZXR1cm5zOiAgICAgIG9iamVjdCBjb250YWluaW5nIHB1YmxpYyBhbmQgcHJpdmF0ZSBrZXkgcGFpcg0KICAvLyBOb3RlczoNCiAgLy8NCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgDQogIEVjTWFrZVNpZ0tleXMgPSBhc3luYyAoZXhwb3J0YWJsZSA9IHRydWUpID0+IHsNCiAgICBhd2FpdCB0aGlzLl9zbGVlcCgwKTsNCg0KICAvLyBTdGVwIDEpIENyZWF0ZSBFQ0RTQSBLZXlTDQogICAgbGV0IGtleXMgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmdlbmVyYXRlS2V5KA0KICAgICAgeyBuYW1lOiAiRUNEU0EiLCBuYW1lZEN1cnZlOiAiUC0yNTYiIH0sDQogICAgICBleHBvcnRhYmxlLA0KICAgICAgWyJzaWduIiwidmVyaWZ5Il0NCiAgICApOw0KICAgIA0KICAgIGxldCBiNjRLZXlzOw0KDQogIC8vIFN0ZXAgMmEpIElGIEVYVFJBQ1RBQkxFOiBFeHBvcnQga2V5cyB0byBTUEtJfFBLQ1M4IGZvcm1hdA0KICAgIGlmKGV4cG9ydGFibGUpew0KICAgICAgYjY0S2V5cyA9IGF3YWl0IFByb21pc2UuYWxsKFsNCiAgICAgICAgdGhpcy5fY3J5cHRvLnN1YnRsZS5leHBvcnRLZXkoInNwa2kiLCBrZXlzLnB1YmxpY0tleSkudGhlbigoa2V5KSA9PiB7DQogICAgICAgICAgcmV0dXJuIHRoaXMuYXJyYXlUb0Jhc2U2NChuZXcgVWludDhBcnJheShrZXkpKTsNCiAgICAgICAgfSksDQogICAgICAgIHRoaXMuX2NyeXB0by5zdWJ0bGUuZXhwb3J0S2V5KCJwa2NzOCIsIGtleXMucHJpdmF0ZUtleSkudGhlbigoa2V5KSA9PiB7DQogICAgICAgICAgcmV0dXJuIHRoaXMuYXJyYXlUb0Jhc2U2NChuZXcgVWludDhBcnJheShrZXkpKTsNCiAgICAgICAgfSkNCiAgICAgIF0pOw0KICAgICAgDQogICAgICByZXR1cm4geyBwdWJsaWNLZXk6IGI2NEtleXNbMF0sIHByaXZhdGVLZXk6IGI2NEtleXNbMV0gfTsNCg0KICAgIH0gZWxzZSB7DQogICAgICANCiAgLy8gU3RlcCAyYikgTk9UIE5PVCBOT1QgRVhUUkFDVEFCTEU6IEV4cG9ydCBqdXN0IHRoZSBwdWJsaWMga2V5DQogICAgICBiNjRLZXlzID0gYXdhaXQgUHJvbWlzZS5hbGwoWw0KICAgICAgICB0aGlzLl9jcnlwdG8uc3VidGxlLmV4cG9ydEtleSgic3BraSIsIGtleXMucHVibGljS2V5KS50aGVuKChrZXkpID0+IHsNCiAgICAgICAgICByZXR1cm4gdGhpcy5hcnJheVRvQmFzZTY0KG5ldyBVaW50OEFycmF5KGtleSkpOw0KICAgICAgICB9KQ0KICAgICAgXSk7DQogICAgICByZXR1cm4geyBwdWJsaWNLZXk6IGI2NEtleXNbMF0sIHByaXZhdGVLZXk6IGtleXMucHJpdmF0ZUtleSB9Ow0KICAgIH0NCg0KICB9Ow0KICANCiAgDQogIA0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KICAvLw0KICAvLyBGdW5jdGlvbjogICAgIEVjU2lnbkRhdGEgKGFzeW5jKQ0KICAvLyBXaGF0IGlzIHRoaXM6IENyZWF0ZSBhIGNyeXB0by1zaWduYXR1cmUgZnJvbSBhIHByaXZhdGUga2V5IGFuZCBkYXRhDQogIC8vDQogIC8vIEFyZ3VtZW50czogICAgYmFzZTY0cHJpdmF0ZUtleTogc3RyaW5nOw0KICAvLyAgICAgICAgICAgICAgIGRhdGE6IFVpbnQ4QXJyYXk7DQogIC8vDQogIC8vIFJldHVybnM6ICAgICAgYmFzZTY0IGVuY29kZWQgc2lnbmF0dXJlDQogIC8vIE5vdGVzOg0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KDQogIEVjU2lnbkRhdGEgPSBhc3luYyAoYjY0UHJpdmF0ZUtleSwgYjY0ZGF0YSkgPT4gew0KICAgIGF3YWl0IHRoaXMuX3NsZWVwKDApOw0KDQogICAgLy8gMS4pIGNvbnZlcnQgdGhlIGdpdmVuIGtleXMgdG8gcmVhbCBrZXlzDQogICAgbGV0IHByaXZhdGVLZXkgPSBhd2FpdCB0aGlzLkVjZHNhQ29udmVydEtleShiNjRQcml2YXRlS2V5KTsNCg0KICAgIC8vIDIuKSBzaWduIHRoZSBkYXRhIHdpdGggdGhlIGxpdmUga2V5DQogICAgbGV0IHNpZ25hdHVyZSA9IGF3YWl0IHRoaXMuX2NyeXB0by5zdWJ0bGUuc2lnbih7Im5hbWUiOiAiRUNEU0EiLCAiaGFzaCI6IHsibmFtZSI6ICJTSEEtMjU2In19LCBwcml2YXRlS2V5LCB0aGlzLmJhc2U2NFRvQXJyYXkoYjY0ZGF0YSkpOw0KDQogICAgLy8gMy4pIEJhc2U2NCBhbmQgcmV0dXJuIG91ciBkYXRhLi4uDQogICAgcmV0dXJuICBhd2FpdCB0aGlzLmFycmF5VG9CYXNlNjQobmV3IFVpbnQ4QXJyYXkoc2lnbmF0dXJlKSk7DQogIA0KICB9Ow0KICANCiAgDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vDQogIC8vIEZ1bmN0aW9uOiAgICAgRWNWZXJpZnlTaWcgKGFzeW5jKQ0KICAvLyBXaGF0IGlzIHRoaXM6IEdpdmVuIGEgcHVibGljIGtleSwgc29tZSBkYXRhLCBhbmQgYSBzaWduYXR1cmU7IHByb3ZlIHRoZQ0KICAvLyAgICAgICAgICAgICAgIHNpZ25hdHVyZSBjYW1lIGZyb20gdGhlIGRhdGEgYW5kIHRoZSBwdWJsaWMga2V5DQogIC8vDQogIC8vIEFyZ3VtZW50czogICAgYmFzZTY0UHVibGljS2V5OiBzdHJpbmc7DQogIC8vICAgICAgICAgICAgICAgZGF0YTogVWludDhBcnJheTsNCiAgLy8NCiAgLy8gUmV0dXJuczogICAgICBiYXNlNjQgZW5jb2RlZCBzaWduYXR1cmUNCiAgLy8gTm90ZXM6DQogIC8vDQogIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQogIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQoNCiAgRWNWZXJpZnlTaWcgPSBhc3luYyAoYjY0UHVibGljS2V5LCBiNjRTaWduYXR1cmUsIGI2NGRhdGEpID0+IHsNCiAgICBhd2FpdCB0aGlzLl9zbGVlcCgwKTsNCg0KICAgIC8vIDEuKSBjb252ZXJ0IHRoZSBnaXZlbiBrZXlzIHRvIHJlYWwga2V5cw0KICAgIGxldCBwdWJsaWNLZXkgPSBhd2FpdCB0aGlzLkVjZHNhQ29udmVydEtleShiNjRQdWJsaWNLZXkpOw0KICAgIA0KDQogICAgLy8gMi4pIENvbnZlcnQgdGhlIHNpZ25hdHVyZSB0byBhbiBhcnJheQ0KICAgIGxldCBzaWduYXR1cmUgPSB0aGlzLmJhc2U2NFRvQXJyYXkoYjY0U2lnbmF0dXJlKTsNCg0KICAgIC8vIDMuKSB2ZXJpZnkgdGhlIGRhdGEgd2l0aCB0aGUgbGl2ZSBrZXkNCiAgICByZXR1cm4gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS52ZXJpZnkoeyJuYW1lIjogIkVDRFNBIiwgImhhc2giOiB7Im5hbWUiOiAiU0hBLTI1NiJ9fSwgcHVibGljS2V5LCBzaWduYXR1cmUsIHRoaXMuYmFzZTY0VG9BcnJheShiNjRkYXRhKSk7DQoNCiAgfTsNCiAgDQogIA0KICANCiAgDQogIA0KICANCiAgDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vDQogIC8vDQogIC8vIEZ1bmN0aW9uOiAgICAgRXpDb252ZXJ0S2V5IChiYXNlNjRrZXkpDQogIC8vIFdoYXQgaXMgdGhpczogU2xvcHB5IEFGIGZ1bmN0aW9uIHRvIHRyeSBjb252ZXJ0aW5nIHJhbmRvbSBkYXRhIGludG8gYSBrZXkNCiAgLy8gICAgICAgICAgICAgICB1bnRpbCBzb21ldGhpbmcgd29ya3MuLi4NCiAgLy8NCiAgLy8gQXJndW1lbnRzOiAgICBub25lDQogIC8vDQogIC8vIFJldHVybnM6ICAgICAgaG9wZWZ1bGx5IGEgbGl2ZSBrZXkuLi5wcm9iYWJseSBhbiBlcnJvciBhbmQgYW4gaG91ciBvZiBkZWJ1Z2dpbmcuDQogIC8vIE5vdGVzOg0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICANCiAgDQogIA0KICBFY2RoQ29udmVydEtleSA9IGFzeW5jICh1bmtub3duX2tleSkgPT4gew0KICAgIGF3YWl0IHRoaXMuX3NsZWVwKDApOw0KDQogICAgbGV0IGtleTsNCiAgICBsZXQgbG9uZ0tleTsNCiAgICANCiAgICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAgIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQogICAgLy8gTkFUVVJBTCBLRVkNCiAgICBpZih1bmtub3duX2tleSBpbnN0YW5jZW9mIHRoaXMuX2NyeXB0by5DcnlwdG9LZXkpew0KICAgICAgcmV0dXJuIHVua25vd25fa2V5Ow0KICAgIH0NCiAgICAvLw0KICAgIC8vDQogICAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAgIC8vIFNQS0kgUFVCTElDPw0KICAgIC8vDQogICAgLy8NCiAgICB0cnkgew0KICAgICAga2V5ID0gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS5pbXBvcnRLZXkoDQogICAgICAgICJzcGtpIiwNCiAgICAgICAgdGhpcy5iYXNlNjRUb0FycmF5KHVua25vd25fa2V5KSwNCiAgICAgICAgeyBuYW1lOiAiRUNESCIsIG5hbWVkQ3VydmU6ICJQLTI1NiIgfSwNCiAgICAgICAgdHJ1ZSwNCiAgICAgICAgW10NCiAgICAgICk7DQogICAgICByZXR1cm4ga2V5Ow0KDQogICAgfSBjYXRjaChlKXt9IC8vIERPIE5PVEhJTkchISENCiAgICAvLw0KICAgIC8vDQogICAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAgIC8vIFJBVyBQVUJMSUMNCiAgICAvLw0KICAgIC8vDQogICAgdHJ5IHsNCiAgICAgIGtleSA9IGF3YWl0IHRoaXMuX2NyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KA0KICAgICAgICAicmF3IiwNCiAgICAgICAgdGhpcy5iYXNlNjRUb0FycmF5KHVua25vd25fa2V5KSwNCiAgICAgICAgeyBuYW1lOiAiRUNESCIsIG5hbWVkQ3VydmU6ICJQLTI1NiIgfSwNCiAgICAgICAgdHJ1ZSwNCiAgICAgICAgW10NCiAgICAgICk7DQogICAgICByZXR1cm4ga2V5Ow0KICAgICAgDQogICAgfSBjYXRjaChlKXt9IC8vIERPIE5PVEhJTkchISENCiAgICAvLw0KICAgIC8vDQogICAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAgIC8vIFBLQ1M4IFBSSVZBVEUNCiAgICAvLw0KICAgIC8vDQogICAgdHJ5ew0KICAgICAga2V5ID0gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS5pbXBvcnRLZXkoDQogICAgICAgICJwa2NzOCIsDQogICAgICAgIHRoaXMuYmFzZTY0VG9BcnJheSh1bmtub3duX2tleSksDQogICAgICAgIHsgbmFtZTogIkVDREgiLCBuYW1lZEN1cnZlOiAiUC0yNTYiIH0sDQogICAgICAgIGZhbHNlLA0KICAgICAgICBbImRlcml2ZUtleSIsImRlcml2ZUJpdHMiXQ0KICAgICAgKTsNCiAgICAgIHJldHVybiBrZXk7DQogICAgICANCiAgICB9IGNhdGNoKGUpe30gLy8gRE8gTk9USElORyEhIQ0KICAgIC8vDQogICAgLy8NCiAgICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAgIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQogICAgLy8gUkFXIFBVQkxJQyAtIFBFUlZFUlRFRA0KICAgIC8vDQogICAgLy8NCiAgICB0cnkgew0KICAgICAgDQogICAgICBsb25nS2V5ID0gbmV3IFVpbnQ4QXJyYXkoWzRdLmNvbmNhdChBcnJheS5mcm9tKHRoaXMuYmFzZTY0VG9BcnJheSh1bmtub3duX2tleSkpKSk7DQogICAgICBrZXkgPSBhd2FpdCB0aGlzLl9jcnlwdG8uc3VidGxlLmltcG9ydEtleSgNCiAgICAgICAgInJhdyIsDQogICAgICAgIGxvbmdLZXksDQogICAgICAgIHsgbmFtZTogIkVDREgiLCBuYW1lZEN1cnZlOiAiUC0yNTYiIH0sDQogICAgICAgIHRydWUsDQogICAgICAgIFtdDQogICAgICApOw0KICAgICAgcmV0dXJuIGtleTsNCiAgICAgIA0KICAgIH0gY2F0Y2goZSl7DQogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVOUkVDT0dOSVpFRCBLRVkgRk9STUFUIik7DQogICAgfQ0KDQoNCg0KICB9DQoNCg0KDQoNCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8NCiAgLy8NCiAgLy8gRnVuY3Rpb246ICAgICBFY2RzYUNvbnZlcnRLZXkgKHNvbWUgc29ydCBvZiBrZXkpDQogIC8vIFdoYXQgaXMgdGhpczogU2xvcHB5IEFGIGZ1bmN0aW9uIHRvIHRyeSBjb252ZXJ0aW5nIHJhbmRvbSBkYXRhIGludG8gYSBrZXkNCiAgLy8gICAgICAgICAgICAgICB1bnRpbCBzb21ldGhpbmcgd29ya3MuLi4NCiAgLy8NCiAgLy8gQXJndW1lbnRzOiAgICBub25lDQogIC8vDQogIC8vIFJldHVybnM6ICAgICAgaG9wZWZ1bGx5IGEgbGl2ZSBrZXkuLi5wcm9iYWJseSBhbiBlcnJvciBhbmQgYW4gaG91ciBvZiBkZWJ1Z2dpbmcuDQogIC8vIE5vdGVzOg0KICAvLw0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICANCiAgRWNkc2FDb252ZXJ0S2V5ID0gYXN5bmMgKHVua25vd25fa2V5KSA9PiB7DQogICAgYXdhaXQgdGhpcy5fc2xlZXAoMCk7DQoNCiAgICBsZXQga2V5Ow0KICAgIGxldCBsb25nS2V5Ow0KICAgIA0KICAgIA0KICAgIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQogICAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgICAvLyBOQVRVUkFMIEtFWQ0KICAgIGlmKHVua25vd25fa2V5IGluc3RhbmNlb2YgdGhpcy5fY3J5cHRvLkNyeXB0b0tleSl7DQogICAgICByZXR1cm4gdW5rbm93bl9rZXk7DQogICAgfQ0KICAgIA0KICAgIA0KICAgIC8vDQogICAgLy8NCiAgICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAgIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQogICAgLy8gU1BLSSBQVUJMSUM/DQogICAgLy8NCiAgICAvLw0KICAgIHRyeSB7DQogICAgICANCiAgICAgIGtleSA9IGF3YWl0IHRoaXMuX2NyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KA0KICAgICAgICAic3BraSIsDQogICAgICAgIHRoaXMuYmFzZTY0VG9BcnJheSh1bmtub3duX2tleSksDQogICAgICAgIHsgbmFtZTogIkVDRFNBIiwgbmFtZWRDdXJ2ZTogIlAtMjU2IiB9LA0KICAgICAgICB0cnVlLA0KICAgICAgICBbInZlcmlmeSJdDQogICAgICApOw0KICAgICAgDQogICAgICByZXR1cm4ga2V5Ow0KICAgICAgDQogICAgfSBjYXRjaChlKXt9IC8vIERPIE5PVEhJTkchDQoNCiAgICAvLw0KICAgIC8vDQogICAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgICAvLyBcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXA0KICAgIC8vIFJBVyBQVUJMSUMNCiAgICAvLw0KICAgIC8vDQogICAgdHJ5IHsNCiAgICAgIA0KICAgICAga2V5ID0gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS5pbXBvcnRLZXkoDQogICAgICAgICJyYXciLA0KICAgICAgICB0aGlzLmJhc2U2NFRvQXJyYXkodW5rbm93bl9rZXkpLA0KICAgICAgICB7IG5hbWU6ICJFQ0RTQSIsIG5hbWVkQ3VydmU6ICJQLTI1NiIgfSwNCiAgICAgICAgdHJ1ZSwNCiAgICAgICAgWyJ2ZXJpZnkiXQ0KICAgICAgKTsNCg0KICAgICAgcmV0dXJuIGtleTsNCiAgICAgIA0KICAgIH0gY2F0Y2goZSl7fSAvLyBETyBOT1RISU5HIQ0KDQogICAgLy8NCiAgICAvLw0KICAgIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQogICAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgICAvLyBQS0NTOCBQUklWQVRFDQogICAgLy8NCiAgICAvLw0KICAgIHRyeXsNCg0KICAgICAga2V5ID0gYXdhaXQgdGhpcy5fY3J5cHRvLnN1YnRsZS5pbXBvcnRLZXkoDQogICAgICAgICJwa2NzOCIsDQogICAgICAgIHRoaXMuYmFzZTY0VG9BcnJheSh1bmtub3duX2tleSksDQogICAgICAgIHsgbmFtZTogIkVDRFNBIiwgbmFtZWRDdXJ2ZTogIlAtMjU2IiB9LA0KICAgICAgICBmYWxzZSwNCiAgICAgICAgWyJzaWduIl0NCiAgICAgICk7DQoNCiAgICAgIHJldHVybiBrZXk7DQogICAgICANCiAgICB9IGNhdGNoKGUpe30gLy8gRE8gTk9USElORw0KDQogICAgLy8NCiAgICAvLw0KICAgIC8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcDQogICAgLy8gXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCiAgICAvLyBSQVcgUFVCTElDIC0gUEVSVkVSVEVEDQogICAgLy8NCiAgICAvLw0KICAgIHRyeSB7DQoNCiAgICAgIGxvbmdLZXkgPSBuZXcgVWludDhBcnJheShbNF0uY29uY2F0KEFycmF5LmZyb20odGhpcy5iYXNlNjRUb0FycmF5KHVua25vd25fa2V5KSkpKTsNCiAgICAgIGtleSA9IGF3YWl0IHRoaXMuX2NyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KA0KICAgICAgICAicmF3IiwNCiAgICAgICAgbG9uZ0tleSwNCiAgICAgICAgeyBuYW1lOiAiRUNEU0EiLCBuYW1lZEN1cnZlOiAiUC0yNTYiIH0sDQogICAgICAgIHRydWUsDQogICAgICAgIFsic2lnbiJdDQogICAgICApOw0KDQogICAgICByZXR1cm4ga2V5Ow0KICAgICAgDQogICAgfSBjYXRjaChlKXsNCiAgICAgIHRocm93IG5ldyBFcnJvcigiVU5SRUNPR05JWkVEIEtFWSBGT1JNQVQiKTsNCiAgICB9DQoNCiAgfQ0KDQogIA0KICANCn0NCi8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCi8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwNCi8vIFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwKCi8qKg0KICogQSBjbGFzcyB0byBzaW1wbGlmeSBpbnRlcmFjdGlvbnMgd2l0aCBJbmRleGVkREIuDQogKi8NCmNsYXNzIEVaaW5kZXhEQnsNCiAgDQogICNkYXRhYmFzZTsNCiAgDQogIC8qKg0KICAgKiBJbml0aWFsaXplcyBhIGNvbm5lY3Rpb24gdG8gdGhlIGRhdGFiYXNlIG9yIGNyZWF0ZXMgaXQgaWYgaXQgZG9lc24ndCBleGlzdC4NCiAgICogDQogICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhYmFzZSAtIFRoZSBuYW1lIG9mIHRoZSBkYXRhYmFzZS4NCiAgICogQHBhcmFtIHtzdHJpbmd9IHRhYmxlIC0gVGhlIG5hbWUgb2YgdGhlIHRhYmxlIChvYmplY3Qgc3RvcmUpLg0KICAgKiBAcGFyYW0ge0FycmF5PHN0cmluZz59IFtpbmRleGVzXSAtIEFuIGFycmF5IG9mIGluZGV4IG5hbWVzIHRvIGJlIGNyZWF0ZWQuDQogICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSBSZXNvbHZlcyB0byB0cnVlIGlmIHN1Y2Nlc3NmdWwuDQogICAqLw0KICBzdGFydCA9IChkYXRhYmFzZSwgdGFibGUsIGluZGV4ZXMpID0+IHsNCiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gew0KICAgICAgLy8gc3RhcnQgY29ubmVjdGlvbiB0byBEQiwgdGhlbiwgbGlzdGVuIGZvciBldmVudHMNCiAgICAgIGNvbnN0IG9wZW5SZXF1ZXN0ID0gaW5kZXhlZERCLm9wZW4oZGF0YWJhc2UsIDEpOw0KICANCiAgICAgIC8vIGhhbmRsZSBlcnJvcg0KICAgICAgb3BlblJlcXVlc3Qub25lcnJvciA9IGV2ZW50ID0+IHsNCiAgICAgICAgcmVqZWN0KGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICB9Ow0KICANCiAgICAgIC8vIHVwZ3JhZGVOZWVkZWQgPz8/DQogICAgICBvcGVuUmVxdWVzdC5vbnVwZ3JhZGVuZWVkZWQgPSBldmVudCA9PiB7DQogICAgICAgIHRoaXMuI2RhdGFiYXNlID0gZXZlbnQudGFyZ2V0LnJlc3VsdDsNCiAgICAgICAgY29uc3Qgc3RvcmUgPSB0aGlzLiNkYXRhYmFzZS5jcmVhdGVPYmplY3RTdG9yZSh0YWJsZSwgeyJrZXlQYXRoIjogImlkIn0pOw0KICAgICAgICANCiAgICAgICAgLy8gSWYgd2UncmUgdGFraW5nIGluZGV4ZXMsIGxldCdzIGNyZWF0ZSBpbmRleGVzDQogICAgICAgIGlmKGluZGV4ZXMpew0KICAgICAgICAgIGluZGV4ZXMuZm9yRWFjaCgoaW5kZXgpID0+IHN0b3JlLmNyZWF0ZUluZGV4KGluZGV4LGluZGV4KSk7DQogICAgICAgIH0NCiAgICAgIH07DQogIA0KICAgICAgb3BlblJlcXVlc3Qub25zdWNjZXNzID0gZXZlbnQgPT4gew0KICAgICAgICB0aGlzLiNkYXRhYmFzZSA9IGV2ZW50LnRhcmdldC5yZXN1bHQ7DQogICAgICAgIHJlc29sdmUodHJ1ZSk7DQogICAgICB9Ow0KICAgIH0pOw0KICB9DQogIA0KICAvKioNCiAgICogQ3JlYXRlcyBhIHRyYW5zYWN0aW9uIGZvciBpbnRlcm5hbCB1c2UuDQogICAqIA0KICAgKiBAcHJpdmF0ZQ0KICAgKiBAcGFyYW0ge3N0cmluZ30gdGFibGUgLSBUaGUgbmFtZSBvZiB0aGUgdGFibGUgKG9iamVjdCBzdG9yZSkuDQogICAqIEByZXR1cm5zIHtJREJPYmplY3RTdG9yZX0gVGhlIG9iamVjdCBzdG9yZSBmb3IgdGhlIHNwZWNpZmllZCB0YWJsZS4NCiAgICovDQogICN0cmFuc2FjdGlvbiA9IGFzeW5jKHRhYmxlKSA9PiB7DQogICAgY29uc3QgdHJhbnNhY3Rpb24gPSBhd2FpdCB0aGlzLiNkYXRhYmFzZS50cmFuc2FjdGlvbih0YWJsZSwgJ3JlYWR3cml0ZScpOw0KICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUodGFibGUpOw0KICAgIHJldHVybiBzdG9yZTsNCiAgfQ0KICANCiAgDQogIC8qKg0KICAgKiBBZGRzIGEgcmVjb3JkIHRvIHRoZSBkYXRhYmFzZSBpZiBpdCBkb2Vzbid0IGV4aXN0Lg0KICAgKiBUaHJvd3MgYW4gZXJyb3IgaWYgdGhlIHJlY29yZCBhbHJlYWR5IGV4aXN0cy4NCiAgICogDQogICAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZSAtIFRoZSBuYW1lIG9mIHRoZSB0YWJsZSAob2JqZWN0IHN0b3JlKS4NCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBUaGUgZGF0YSB0byBiZSBhZGRlZC4NCiAgICogQHJldHVybnMge1Byb21pc2U8SURCVmFsaWRLZXk+fSBSZXNvbHZlcyB0byB0aGUga2V5IG9mIHRoZSBhZGRlZCByZWNvcmQuDQogICAqLw0KICBjcmVhdGVzID0gKHRhYmxlLCBkYXRhKSA9PiB7DQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsNCiAgICAgIC8vIHN0YXJ0IGEgdHJhbnNhY3Rpb24NCiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy4jZGF0YWJhc2UudHJhbnNhY3Rpb24odGFibGUsICdyZWFkd3JpdGUnKTsNCiAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUodGFibGUpOw0KICANCiAgICAgIC8vIFRyeSBhZGRpbmcgZGF0YSB0byB0aGUgc3RvcmUNCiAgICAgIGNvbnN0IHJlcXVlc3QgPSBzdG9yZS5hZGQoZGF0YSk7DQogIA0KICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiB7DQogICAgICAgIHJlc29sdmUocmVxdWVzdC5yZXN1bHQpOw0KICAgICAgfTsNCiAgDQogICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoZXZlbnQpID0+IHsNCiAgICAgICAgY29uc29sZS5lcnJvcigiRXJyb3IgYWRkaW5nIGRhdGEgdG8gSW5kZXhlZERCOiIsIGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICAgIHJlamVjdChldmVudC50YXJnZXQuZXJyb3IpOw0KICAgICAgfTsNCiAgDQogICAgICAvLyBIYW5kbGUgdHJhbnNhY3Rpb24gZXJyb3JzDQogICAgICB0cmFuc2FjdGlvbi5vbmVycm9yID0gKGV2ZW50KSA9PiB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoIlRyYW5zYWN0aW9uIGVycm9yOiIsIGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICB9Ow0KICAgIH0pOw0KICB9DQogIA0KICANCiAgLyoqDQogICAqIFJldHJpZXZlcyBhIHJlY29yZCBmcm9tIHRoZSBkYXRhYmFzZSBieSBpdHMgSUQuDQogICAqIA0KICAgKiBAcGFyYW0ge3N0cmluZ30gdGFibGUgLSBUaGUgbmFtZSBvZiB0aGUgdGFibGUgKG9iamVjdCBzdG9yZSkuDQogICAqIEBwYXJhbSB7SURCVmFsaWRLZXl9IGlkIC0gVGhlIElEIG9mIHRoZSByZWNvcmQgdG8gcmV0cmlldmUuDQogICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59IFJlc29sdmVzIHRvIHRoZSByZXRyaWV2ZWQgcmVjb3JkLg0KICAgKi8NCiAgcmVhZHMgPSAodGFibGUsIGlkKSA9PiB7DQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsNCiAgICAgIC8vIHN0YXJ0IGEgdHJhbnNhY3Rpb24NCiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy4jZGF0YWJhc2UudHJhbnNhY3Rpb24odGFibGUsICdyZWFkb25seScpOw0KICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZSh0YWJsZSk7DQogICAgICANCiAgICAgIC8vIFRyeSBnZXR0aW5nIHNvbWUgaW5mb3JtYXRpb24gb3V0IG9mIHRoZSBkYXRhYmFzZQ0KICAgICAgY29uc3QgcmVxdWVzdCA9IHN0b3JlLmdldChpZCk7DQogICAgICANCiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4gew0KICAgICAgICByZXNvbHZlKHJlcXVlc3QucmVzdWx0KTsNCiAgICAgIH07DQogIA0KICAgICAgcmVxdWVzdC5vbmVycm9yID0gKGV2ZW50KSA9PiB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yIHJlYWRpbmcgZGF0YSBmcm9tIEluZGV4ZWREQjoiLCBldmVudC50YXJnZXQuZXJyb3IpOw0KICAgICAgICByZWplY3QoZXZlbnQudGFyZ2V0LmVycm9yKTsNCiAgICAgIH07DQogIA0KICAgICAgLy8gSGFuZGxlIHRyYW5zYWN0aW9uIGVycm9ycw0KICAgICAgdHJhbnNhY3Rpb24ub25lcnJvciA9IChldmVudCkgPT4gew0KICAgICAgICBjb25zb2xlLmVycm9yKCJUcmFuc2FjdGlvbiBlcnJvcjoiLCBldmVudC50YXJnZXQuZXJyb3IpOw0KICAgICAgfTsNCiAgICB9KTsNCiAgfQ0KICANCiAgDQogIC8qKg0KICAgKiBVcGRhdGVzIGFuIGV4aXN0aW5nIHJlY29yZCBpbiB0aGUgZGF0YWJhc2UuDQogICAqIFRocm93cyBhbiBlcnJvciBpZiB0aGUgcmVjb3JkIGRvZXNuJ3QgZXhpc3QuDQogICAqIA0KICAgKiBAcGFyYW0ge3N0cmluZ30gdGFibGUgLSBUaGUgbmFtZSBvZiB0aGUgdGFibGUgKG9iamVjdCBzdG9yZSkuDQogICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIC0gVGhlIGRhdGEgdG8gdXBkYXRlLg0KICAgKiBAcmV0dXJucyB7UHJvbWlzZTxJREJWYWxpZEtleT59IFJlc29sdmVzIHRvIHRoZSBrZXkgb2YgdGhlIHVwZGF0ZWQgcmVjb3JkLg0KICAgKi8NCiAgdXBkYXRlcyA9ICh0YWJsZSwgZGF0YSkgPT4gew0KICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7DQogICAgICAvLyBzZWUgaWYgdGhlIHRoaW5nIGV4aXN0cyBmaXJzdC4NCiAgICAgIC8vIGlmIG5vdCwgZmFpbCBpdA0KICAgICAgbGV0IHRlc3RfZGF0YSA9IGF3YWl0IHRoaXMucmVhZHModGFibGUsIGRhdGEuaWQpOw0KICAgICAgDQogICAgICBpZighdGVzdF9kYXRhKXsNCiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiQSByZWNvcmQgbXVzdCBleGlzdCBiZWZvcmUgeW91IGNhbiB1cGRhdGUgaXQiKSk7DQogICAgICB9DQogIA0KICAgICAgLy8gc3RhcnQgYSB0cmFuc2FjdGlvbg0KICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSB0aGlzLiNkYXRhYmFzZS50cmFuc2FjdGlvbih0YWJsZSwgJ3JlYWR3cml0ZScpOw0KICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZSh0YWJsZSk7DQogICAgICANCiAgICAgIC8vIFRyeSB1cGRhdGluZyBkYXRhIGluIHRoZSBzdG9yZQ0KICAgICAgY29uc3QgcmVxdWVzdCA9IHN0b3JlLnB1dCh7Li4udGVzdF9kYXRhLCAuLi5kYXRhfSk7DQogICAgICANCiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4gew0KICAgICAgICByZXNvbHZlKHJlcXVlc3QucmVzdWx0KTsNCiAgICAgIH07DQogIA0KICAgICAgcmVxdWVzdC5vbmVycm9yID0gKGV2ZW50KSA9PiB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yIHVwZGF0aW5nIGRhdGEgaW4gSW5kZXhlZERCOiIsIGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICAgIHJlamVjdChldmVudC50YXJnZXQuZXJyb3IpOw0KICAgICAgfTsNCiAgDQogICAgICAvLyBIYW5kbGUgdHJhbnNhY3Rpb24gZXJyb3JzDQogICAgICB0cmFuc2FjdGlvbi5vbmVycm9yID0gKGV2ZW50KSA9PiB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoIlRyYW5zYWN0aW9uIGVycm9yOiIsIGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICB9Ow0KICAgIH0pOw0KICB9DQogIA0KICAvKioNCiAgICogSW5zZXJ0cyBvciB1cGRhdGVzIGEgcmVjb3JkIGluIHRoZSBkYXRhYmFzZS4NCiAgICogDQogICAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZSAtIFRoZSBuYW1lIG9mIHRoZSB0YWJsZSAob2JqZWN0IHN0b3JlKS4NCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBUaGUgZGF0YSB0byBpbnNlcnQgb3IgdXBkYXRlLg0KICAgKiBAcmV0dXJucyB7UHJvbWlzZTxJREJWYWxpZEtleT59IFJlc29sdmVzIHRvIHRoZSBrZXkgb2YgdGhlIGluc2VydGVkIG9yIHVwZGF0ZWQgcmVjb3JkLg0KICAgKi8NCiAgdXBzZXJ0cyA9ICh0YWJsZSwgZGF0YSkgPT4gew0KICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7DQogICAgICAvLyBzZWUgaWYgdGhlIHRoaW5nIGV4aXN0cyBmaXJzdC4NCiAgICAgIC8vIGlmIG5vdCwgZmFpbCBpdA0KICAgICAgbGV0IHRlc3RfZGF0YSA9IGF3YWl0IHRoaXMucmVhZHModGFibGUsIGRhdGEuaWQpOw0KICANCiAgICAgIC8vIHN0YXJ0IGEgdHJhbnNhY3Rpb24NCiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy4jZGF0YWJhc2UudHJhbnNhY3Rpb24odGFibGUsICdyZWFkd3JpdGUnKTsNCiAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUodGFibGUpOw0KICAgICAgbGV0IHJlcXVlc3Q7DQoNCiAgICAgIC8vIFRyeSB1cGRhdGluZyBkYXRhIGluIHRoZSBzdG9yZQ0KICAgICAgaWYodGVzdF9kYXRhKXsNCiAgICAgICAgcmVxdWVzdCA9IHN0b3JlLnB1dCh7Li4udGVzdF9kYXRhLCAuLi5kYXRhfSk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXF1ZXN0ID0gc3RvcmUuYWRkKGRhdGEpOw0KICAgICAgfQ0KIA0KICAgICAgDQogICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHsNCiAgICAgICAgcmVzb2x2ZShyZXF1ZXN0LnJlc3VsdCk7DQogICAgICB9Ow0KICANCiAgICAgIHJlcXVlc3Qub25lcnJvciA9IChldmVudCkgPT4gew0KICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvciB1cGRhdGluZyBkYXRhIGluIEluZGV4ZWREQjoiLCBldmVudC50YXJnZXQuZXJyb3IpOw0KICAgICAgICByZWplY3QoZXZlbnQudGFyZ2V0LmVycm9yKTsNCiAgICAgIH07DQogIA0KICAgICAgLy8gSGFuZGxlIHRyYW5zYWN0aW9uIGVycm9ycw0KICAgICAgdHJhbnNhY3Rpb24ub25lcnJvciA9IChldmVudCkgPT4gew0KICAgICAgICBjb25zb2xlLmVycm9yKCJUcmFuc2FjdGlvbiBlcnJvcjoiLCBldmVudC50YXJnZXQuZXJyb3IpOw0KICAgICAgfTsNCiAgICB9KTsNCiAgfQ0KICANCiAgLyoqDQogICAqIERlbGV0ZXMgYSByZWNvcmQgZnJvbSB0aGUgZGF0YWJhc2UgYnkgaXRzIElELg0KICAgKiANCiAgICogQHBhcmFtIHtzdHJpbmd9IHRhYmxlIC0gVGhlIG5hbWUgb2YgdGhlIHRhYmxlIChvYmplY3Qgc3RvcmUpLg0KICAgKiBAcGFyYW0ge0lEQlZhbGlkS2V5fSBpZCAtIFRoZSBJRCBvZiB0aGUgcmVjb3JkIHRvIGRlbGV0ZS4NCiAgICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IFJlc29sdmVzIHRvIHRydWUgaWYgdGhlIGRlbGV0aW9uIHdhcyBzdWNjZXNzZnVsLg0KICAgKi8NCiAgZGVsZXRlcyA9ICh0YWJsZSwgaWQpID0+IHsNCiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gew0KICAgICAgLy8gc3RhcnQgYSB0cmFuc2FjdGlvbg0KICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSB0aGlzLiNkYXRhYmFzZS50cmFuc2FjdGlvbih0YWJsZSwgJ3JlYWR3cml0ZScpOw0KICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZSh0YWJsZSk7DQogICAgICANCiAgICAgIC8vIFRyeSBkZWxldGluZyB0aGUgcmVjb3JkIGZyb20gdGhlIHN0b3JlDQogICAgICBjb25zdCByZXF1ZXN0ID0gc3RvcmUuZGVsZXRlKGlkKTsNCiAgICAgIA0KICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiB7DQogICAgICAgIHJlc29sdmUodHJ1ZSk7DQogICAgICB9Ow0KICANCiAgICAgIHJlcXVlc3Qub25lcnJvciA9IChldmVudCkgPT4gew0KICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvciBkZWxldGluZyByZWNvcmQgZnJvbSBJbmRleGVkREI6IiwgZXZlbnQudGFyZ2V0LmVycm9yKTsNCiAgICAgICAgcmVqZWN0KGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICB9Ow0KICANCiAgICAgIC8vIEhhbmRsZSB0cmFuc2FjdGlvbiBlcnJvcnMNCiAgICAgIHRyYW5zYWN0aW9uLm9uZXJyb3IgPSAoZXZlbnQpID0+IHsNCiAgICAgICAgY29uc29sZS5lcnJvcigiVHJhbnNhY3Rpb24gZXJyb3I6IiwgZXZlbnQudGFyZ2V0LmVycm9yKTsNCiAgICAgIH07DQogICAgfSk7DQogIH0NCiAgDQogIC8qKg0KICAgKiBTZWFyY2hlcyBmb3IgcmVjb3JkcyBpbiB0aGUgZGF0YWJhc2UgYnkgYSBzcGVjaWZpZWQgZmllbGQgYW5kIHZhbHVlLg0KICAgKiANCiAgICogQHBhcmFtIHtzdHJpbmd9IHRhYmxlIC0gVGhlIG5hbWUgb2YgdGhlIHRhYmxlIChvYmplY3Qgc3RvcmUpLg0KICAgKiBAcGFyYW0ge3N0cmluZ30gZmllbGQgLSBUaGUgbmFtZSBvZiB0aGUgZmllbGQgdG8gc2VhcmNoIGJ5Lg0KICAgKiBAcGFyYW0ge2FueX0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4NCiAgICogQHJldHVybnMge1Byb21pc2U8QXJyYXk8T2JqZWN0Pj59IFJlc29sdmVzIHRvIGFuIGFycmF5IG9mIG1hdGNoaW5nIHJlY29yZHMuDQogICAqLw0KICBzZWFyY2hlcyA9ICh0YWJsZSwgZmllbGQsIHZhbHVlKSA9PiB7DQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsNCiAgICAgIC8vIHN0YXJ0IGEgdHJhbnNhY3Rpb24NCiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy4jZGF0YWJhc2UudHJhbnNhY3Rpb24odGFibGUsICdyZWFkb25seScpOw0KICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZSh0YWJsZSk7DQogICAgICANCiAgICAgIC8vIFNldCBSZWZlcmVuY2UgdG8gb3VyIEluZGV4DQogICAgICBsZXQgbmR4ID0gc3RvcmUuaW5kZXgoZmllbGQpOw0KICAgICAgDQogICAgICAvLyBUcnkgZ2V0dGluZyBzb21lIGluZm9ybWF0aW9uIG91dCBvZiB0aGUgZGF0YWJhc2UNCiAgICAgIGNvbnN0IHJlcXVlc3QgPSBuZHguZ2V0QWxsKHZhbHVlKTsNCiAgICAgIA0KICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiB7DQogICAgICAgIC8vIFRoZSByZXN1bHQgb2YgdGhlIHJlcXVlc3Qgd2lsbCBiZSBpbiByZXF1ZXN0LnJlc3VsdA0KICAgICAgICByZXNvbHZlKHJlcXVlc3QucmVzdWx0KTsNCiAgICAgIH07DQogIA0KICAgICAgcmVxdWVzdC5vbmVycm9yID0gKGV2ZW50KSA9PiB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yIHJlYWRpbmcgZnJvbSBJbmRleGVkREI6IiwgZXZlbnQudGFyZ2V0LmVycm9yKTsNCiAgICAgICAgcmVqZWN0KGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICB9Ow0KICAgICAgDQogICAgICAvLyBIYW5kbGUgdHJhbnNhY3Rpb24gZXJyb3JzDQogICAgICB0cmFuc2FjdGlvbi5vbmVycm9yID0gKGV2ZW50KSA9PiB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoIlRyYW5zYWN0aW9uIGVycm9yOiIsIGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICB9Ow0KICAgIH0pOw0KDQogIH0NCg0KICAgIA0KICAvKioNCiAgICogUmV0cmlldmVzIGFsbCByZWNvcmRzIGZyb20gYSB0YWJsZS4NCiAgICogDQogICAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZSAtIFRoZSBuYW1lIG9mIHRoZSB0YWJsZSAob2JqZWN0IHN0b3JlKS4NCiAgICogQHJldHVybnMge1Byb21pc2U8QXJyYXk8T2JqZWN0Pj59IFJlc29sdmVzIHRvIGFuIGFycmF5IG9mIGFsbCByZWNvcmRzLg0KICAgKi8NCiAgZ2V0QWxsID0gKHRhYmxlKSA9PiB7DQogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsNCiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy4jZGF0YWJhc2UudHJhbnNhY3Rpb24odGFibGUsICdyZWFkb25seScpOw0KICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZSh0YWJsZSk7DQogICAgICBjb25zdCByZXF1ZXN0ID0gc3RvcmUub3BlbkN1cnNvcigpOw0KICAgICAgY29uc3QgYWxsUmVjb3JkcyA9IFtdOw0KDQogICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IChldmVudCkgPT4gew0KICAgICAgICBjb25zdCBjdXJzb3IgPSBldmVudC50YXJnZXQucmVzdWx0Ow0KICAgICAgICBpZiAoY3Vyc29yKSB7DQogICAgICAgICAgYWxsUmVjb3Jkcy5wdXNoKGN1cnNvci52YWx1ZSk7DQogICAgICAgICAgY3Vyc29yLmNvbnRpbnVlKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmVzb2x2ZShhbGxSZWNvcmRzKTsNCiAgICAgICAgfQ0KICAgICAgfTsNCg0KICAgICAgcmVxdWVzdC5vbmVycm9yID0gKGV2ZW50KSA9PiB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yIHJldHJpZXZpbmcgYWxsIHJlY29yZHMgZnJvbSBJbmRleGVkREI6IiwgZXZlbnQudGFyZ2V0LmVycm9yKTsNCiAgICAgICAgcmVqZWN0KGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICB9Ow0KDQogICAgICB0cmFuc2FjdGlvbi5vbmVycm9yID0gKGV2ZW50KSA9PiB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoIlRyYW5zYWN0aW9uIGVycm9yOiIsIGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICB9Ow0KICAgIH0pOw0KICB9DQoNCiAgLyoqDQogICAqIENvdW50cyB0aGUgbnVtYmVyIG9mIHJlY29yZHMgaW4gYSB0YWJsZS4NCiAgICogDQogICAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZSAtIFRoZSBuYW1lIG9mIHRoZSB0YWJsZSAob2JqZWN0IHN0b3JlKS4NCiAgICogQHJldHVybnMge1Byb21pc2U8bnVtYmVyPn0gUmVzb2x2ZXMgdG8gdGhlIGNvdW50IG9mIHJlY29yZHMuDQogICAqLw0KICBjb3VudFJlY29yZHMgPSAodGFibGUpID0+IHsNCiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gew0KICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSB0aGlzLiNkYXRhYmFzZS50cmFuc2FjdGlvbih0YWJsZSwgJ3JlYWRvbmx5Jyk7DQogICAgICBjb25zdCBzdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHRhYmxlKTsNCiAgICAgIGNvbnN0IHJlcXVlc3QgPSBzdG9yZS5jb3VudCgpOw0KDQogICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHsNCiAgICAgICAgcmVzb2x2ZShyZXF1ZXN0LnJlc3VsdCk7DQogICAgICB9Ow0KDQogICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoZXZlbnQpID0+IHsNCiAgICAgICAgY29uc29sZS5lcnJvcigiRXJyb3IgY291bnRpbmcgcmVjb3JkcyBpbiBJbmRleGVkREI6IiwgZXZlbnQudGFyZ2V0LmVycm9yKTsNCiAgICAgICAgcmVqZWN0KGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICB9Ow0KDQogICAgICB0cmFuc2FjdGlvbi5vbmVycm9yID0gKGV2ZW50KSA9PiB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoIlRyYW5zYWN0aW9uIGVycm9yOiIsIGV2ZW50LnRhcmdldC5lcnJvcik7DQogICAgICB9Ow0KICAgIH0pOw0KICB9DQoNCiAgDQp9DQoNCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KLy8gREVNTzoNCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLw0KDQovKg0KLy8gSW5zdGFudGlhdGUgdGhlIERCDQogIGxldCBleiA9IG5ldyBFWmluZGV4REIoKTsNCiAgDQovLw0KLy8gTGlzdCBhbnkgb2YgdGhlIGZpZWxkcyB3ZSBtaWdodCB3YW50IHRvIHNlYXJjaCBvbg0KLy8gdGhhdCBhcmVuJ3QgImlkIg0KLy8NCiAgYXdhaXQgZXouc3RhcnQoImNvbXBhbnkiLCJwZW9wbGUiLFsibmFtZSJdKTsNCg0KLy8NCi8vIERlbW9uc3RyYXRpb24gb2YgYWRkaW5nIHBlb3BsZSB0byBvdXIgREINCi8vDQogIGF3YWl0IGV6LmNyZWF0ZXMoInBlb3BsZSIseyJpZCI6ICIxIiwgInNhbGFyeSI6IDEyLCAibmFtZSI6ICJTVEVWRSJ9KTsNCiAgYXdhaXQgZXouY3JlYXRlcygicGVvcGxlIix7ImlkIjogIjIiLCAic2FsYXJ5IjogMTIsICJuYW1lIjogIkVERFkifSk7DQogIGF3YWl0IGV6LmNyZWF0ZXMoInBlb3BsZSIseyJpZCI6ICIzIiwgInNhbGFyeSI6IDEyLCAibmFtZSI6ICJKT0UifSk7DQogIGF3YWl0IGV6LmNyZWF0ZXMoInBlb3BsZSIseyJpZCI6ICI0IiwgInNhbGFyeSI6IDEzLCAibmFtZSI6ICJKT0UifSk7DQoNCi8vDQovLyBGaW5kIGV2ZXJ5Ym9keSBuYW1lZCAiSk9FIg0KLy8NCiAgbGV0IGRhdGEgPSBhd2FpdCBlei5zZWFyY2hlcygicGVvcGxlIiwibmFtZSIsICJKT0UiKTsNCiAgDQovLw0KLy8gU2V0IEpvZSdzIFNhbGFyeSB0byAxMl8wMDANCi8vDQogIGF3YWl0IGV6LnVwZGF0ZXMoInBlb3BsZSIseyJpZCI6ICIzIiwgInNhbGFyeSI6IDEyXzAwMH0pOw0KICANCi8vDQovLyBNYWtlIHN1cmUgd2UgY2FuJ3QgJ3Vwc2VydCcgYSByZWNvcmQNCi8vDQogIGF3YWl0IGV6LnVwZGF0ZXMoInBlb3BsZSIseyJpZCI6ICJuZXdiIiwgInNhbGFyeSI6IDEyXzAwMH0pOyAgLy8gdGhpcyBvbmUgZmFpbHMNCiovDQoNCg0KDQovKioNCiAqIEEgY2xhc3MgdG8gc2ltdWxhdGUgaW50ZXJhY3Rpb25zIHdpdGggSW5kZXhlZERCIHVzaW5nIGluLW1lbW9yeSBzdG9yYWdlLg0KICovDQpjbGFzcyBTeW50aEV6SW5kZXhEQiB7DQogIC8qKg0KICAgKiBJbi1tZW1vcnkgc3RvcmFnZSBvYmplY3QuDQogICAqIEB0eXBlIHtPYmplY3R9DQogICAqIEBwcml2YXRlDQogICAqLw0KICAjaW5NZW1vcnlTdG9yYWdlID0ge307DQoNCiAgLyoqDQogICAqIEluaXRpYWxpemVzIGEgY29ubmVjdGlvbiB0byB0aGUgaW4tbWVtb3J5IGRhdGFiYXNlIG9yIGNyZWF0ZXMgaXQgaWYgaXQgZG9lc24ndCBleGlzdC4NCiAgICogDQogICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhYmFzZSAtIFRoZSBuYW1lIG9mIHRoZSBkYXRhYmFzZS4NCiAgICogQHBhcmFtIHtzdHJpbmd9IHRhYmxlIC0gVGhlIG5hbWUgb2YgdGhlIHRhYmxlIChvYmplY3Qgc3RvcmUpLg0KICAgKiBAcGFyYW0ge0FycmF5PHN0cmluZz59IFtpbmRleGVzXSAtIEFuIGFycmF5IG9mIGluZGV4IG5hbWVzIHRvIGJlIGNyZWF0ZWQgKGlnbm9yZWQgaW4gdGhpcyBpbXBsZW1lbnRhdGlvbikuDQogICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSBSZXNvbHZlcyB0byB0cnVlIGlmIHN1Y2Nlc3NmdWwuDQogICAqLw0KICBzdGFydCA9IGFzeW5jIChkYXRhYmFzZSwgdGFibGUsIGluZGV4ZXMpID0+IHsNCiAgICBpZiAoIXRoaXMuI2luTWVtb3J5U3RvcmFnZVtkYXRhYmFzZV0pIHsNCiAgICAgIHRoaXMuI2luTWVtb3J5U3RvcmFnZVtkYXRhYmFzZV0gPSB7fTsNCiAgICB9DQogICAgaWYgKCF0aGlzLiNpbk1lbW9yeVN0b3JhZ2VbZGF0YWJhc2VdW3RhYmxlXSkgew0KICAgICAgdGhpcy4jaW5NZW1vcnlTdG9yYWdlW2RhdGFiYXNlXVt0YWJsZV0gPSB7fTsNCiAgICB9DQogICAgcmV0dXJuIHRydWU7DQogIH07DQoNCiAgLyoqDQogICAqIEFkZHMgYSByZWNvcmQgdG8gdGhlIGluLW1lbW9yeSBkYXRhYmFzZSBpZiBpdCBkb2Vzbid0IGV4aXN0Lg0KICAgKiBUaHJvd3MgYW4gZXJyb3IgaWYgdGhlIHJlY29yZCBhbHJlYWR5IGV4aXN0cy4NCiAgICogDQogICAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZSAtIFRoZSBuYW1lIG9mIHRoZSB0YWJsZSAob2JqZWN0IHN0b3JlKS4NCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBUaGUgZGF0YSB0byBiZSBhZGRlZC4NCiAgICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nPn0gUmVzb2x2ZXMgdG8gdGhlIGtleSBvZiB0aGUgYWRkZWQgcmVjb3JkLg0KICAgKi8NCiAgY3JlYXRlcyA9IGFzeW5jICh0YWJsZSwgZGF0YSkgPT4gew0KICAgIGNvbnN0IGRiID0gdGhpcy4jaW5NZW1vcnlTdG9yYWdlOw0KICAgIGlmICghZGJbdGFibGVdKSB7DQogICAgICBkYlt0YWJsZV0gPSB7fTsNCiAgICB9DQogICAgaWYgKGRiW3RhYmxlXVtkYXRhLmlkXSkgew0KICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWNvcmQgYWxyZWFkeSBleGlzdHMiKTsNCiAgICB9DQogICAgZGJbdGFibGVdW2RhdGEuaWRdID0gZGF0YTsNCiAgICByZXR1cm4gZGF0YS5pZDsNCiAgfTsNCg0KICAvKioNCiAgICogUmV0cmlldmVzIGEgcmVjb3JkIGZyb20gdGhlIGluLW1lbW9yeSBkYXRhYmFzZSBieSBpdHMgSUQuDQogICAqIA0KICAgKiBAcGFyYW0ge3N0cmluZ30gdGFibGUgLSBUaGUgbmFtZSBvZiB0aGUgdGFibGUgKG9iamVjdCBzdG9yZSkuDQogICAqIEBwYXJhbSB7c3RyaW5nfSBpZCAtIFRoZSBJRCBvZiB0aGUgcmVjb3JkIHRvIHJldHJpZXZlLg0KICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3Q+fSBSZXNvbHZlcyB0byB0aGUgcmV0cmlldmVkIHJlY29yZC4NCiAgICovDQogIHJlYWRzID0gYXN5bmMgKHRhYmxlLCBpZCkgPT4gew0KICAgIGNvbnN0IGRiID0gdGhpcy4jaW5NZW1vcnlTdG9yYWdlOw0KICAgIHJldHVybiBkYlt0YWJsZV0gPyBkYlt0YWJsZV1baWRdIDogdW5kZWZpbmVkOw0KICB9Ow0KDQogIC8qKg0KICAgKiBVcGRhdGVzIGFuIGV4aXN0aW5nIHJlY29yZCBpbiB0aGUgaW4tbWVtb3J5IGRhdGFiYXNlLg0KICAgKiBUaHJvd3MgYW4gZXJyb3IgaWYgdGhlIHJlY29yZCBkb2Vzbid0IGV4aXN0Lg0KICAgKiANCiAgICogQHBhcmFtIHtzdHJpbmd9IHRhYmxlIC0gVGhlIG5hbWUgb2YgdGhlIHRhYmxlIChvYmplY3Qgc3RvcmUpLg0KICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIFRoZSBkYXRhIHRvIHVwZGF0ZS4NCiAgICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nPn0gUmVzb2x2ZXMgdG8gdGhlIGtleSBvZiB0aGUgdXBkYXRlZCByZWNvcmQuDQogICAqLw0KICB1cGRhdGVzID0gYXN5bmMgKHRhYmxlLCBkYXRhKSA9PiB7DQogICAgY29uc3QgZGIgPSB0aGlzLiNpbk1lbW9yeVN0b3JhZ2U7DQogICAgaWYgKCFkYlt0YWJsZV0gfHwgIWRiW3RhYmxlXVtkYXRhLmlkXSkgew0KICAgICAgdGhyb3cgbmV3IEVycm9yKCJBIHJlY29yZCBtdXN0IGV4aXN0IGJlZm9yZSB5b3UgY2FuIHVwZGF0ZSBpdCIpOw0KICAgIH0NCiAgICBkYlt0YWJsZV1bZGF0YS5pZF0gPSB7IC4uLmRiW3RhYmxlXVtkYXRhLmlkXSwgLi4uZGF0YSB9Ow0KICAgIHJldHVybiBkYXRhLmlkOw0KICB9Ow0KDQogIC8qKg0KICAgKiBJbnNlcnRzIG9yIHVwZGF0ZXMgYSByZWNvcmQgaW4gdGhlIGluLW1lbW9yeSBkYXRhYmFzZS4NCiAgICogDQogICAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZSAtIFRoZSBuYW1lIG9mIHRoZSB0YWJsZSAob2JqZWN0IHN0b3JlKS4NCiAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgLSBUaGUgZGF0YSB0byBpbnNlcnQgb3IgdXBkYXRlLg0KICAgKiBAcmV0dXJucyB7UHJvbWlzZTxzdHJpbmc+fSBSZXNvbHZlcyB0byB0aGUga2V5IG9mIHRoZSBpbnNlcnRlZCBvciB1cGRhdGVkIHJlY29yZC4NCiAgICovDQogIHVwc2VydHMgPSBhc3luYyAodGFibGUsIGRhdGEpID0+IHsNCiAgICBjb25zdCBkYiA9IHRoaXMuI2luTWVtb3J5U3RvcmFnZTsNCiAgICBpZiAoIWRiW3RhYmxlXSkgew0KICAgICAgZGJbdGFibGVdID0ge307DQogICAgfQ0KICAgIGRiW3RhYmxlXVtkYXRhLmlkXSA9IHsgLi4uZGJbdGFibGVdW2RhdGEuaWRdLCAuLi5kYXRhIH07DQogICAgcmV0dXJuIGRhdGEuaWQ7DQogIH07DQoNCiAgLyoqDQogICAqIERlbGV0ZXMgYSByZWNvcmQgZnJvbSB0aGUgaW4tbWVtb3J5IGRhdGFiYXNlIGJ5IGl0cyBJRC4NCiAgICogDQogICAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZSAtIFRoZSBuYW1lIG9mIHRoZSB0YWJsZSAob2JqZWN0IHN0b3JlKS4NCiAgICogQHBhcmFtIHtzdHJpbmd9IGlkIC0gVGhlIElEIG9mIHRoZSByZWNvcmQgdG8gZGVsZXRlLg0KICAgKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn0gUmVzb2x2ZXMgdG8gdHJ1ZSBpZiB0aGUgZGVsZXRpb24gd2FzIHN1Y2Nlc3NmdWwuDQogICAqLw0KICBkZWxldGVzID0gYXN5bmMgKHRhYmxlLCBpZCkgPT4gew0KICAgIGNvbnN0IGRiID0gdGhpcy4jaW5NZW1vcnlTdG9yYWdlOw0KICAgIGlmICghZGJbdGFibGVdIHx8ICFkYlt0YWJsZV1baWRdKSB7DQogICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlY29yZCBub3QgZm91bmQiKTsNCiAgICB9DQogICAgZGVsZXRlIGRiW3RhYmxlXVtpZF07DQogICAgcmV0dXJuIHRydWU7DQogIH07DQoNCiAgLyoqDQogICAqIFNlYXJjaGVzIGZvciByZWNvcmRzIGluIHRoZSBpbi1tZW1vcnkgZGF0YWJhc2UgYnkgYSBzcGVjaWZpZWQgZmllbGQgYW5kIHZhbHVlLg0KICAgKiANCiAgICogQHBhcmFtIHtzdHJpbmd9IHRhYmxlIC0gVGhlIG5hbWUgb2YgdGhlIHRhYmxlIChvYmplY3Qgc3RvcmUpLg0KICAgKiBAcGFyYW0ge3N0cmluZ30gZmllbGQgLSBUaGUgbmFtZSBvZiB0aGUgZmllbGQgdG8gc2VhcmNoIGJ5Lg0KICAgKiBAcGFyYW0ge2FueX0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4NCiAgICogQHJldHVybnMge1Byb21pc2U8QXJyYXk8T2JqZWN0Pj59IFJlc29sdmVzIHRvIGFuIGFycmF5IG9mIG1hdGNoaW5nIHJlY29yZHMuDQogICAqLw0KICBzZWFyY2hlcyA9IGFzeW5jICh0YWJsZSwgZmllbGQsIHZhbHVlKSA9PiB7DQogICAgY29uc3QgZGIgPSB0aGlzLiNpbk1lbW9yeVN0b3JhZ2U7DQogICAgaWYgKCFkYlt0YWJsZV0pIHsNCiAgICAgIHJldHVybiBbXTsNCiAgICB9DQogICAgcmV0dXJuIE9iamVjdC52YWx1ZXMoZGJbdGFibGVdKS5maWx0ZXIocmVjb3JkID0+IHJlY29yZFtmaWVsZF0gPT09IHZhbHVlKTsNCiAgfTsNCg0KDQogIC8qKg0KICAgKiBSZXRyaWV2ZXMgYWxsIHJlY29yZHMgZnJvbSBhIHRhYmxlIGluIHRoZSBpbi1tZW1vcnkgZGF0YWJhc2UuDQogICAqIA0KICAgKiBAcGFyYW0ge3N0cmluZ30gdGFibGUgLSBUaGUgbmFtZSBvZiB0aGUgdGFibGUgKG9iamVjdCBzdG9yZSkuDQogICAqIEByZXR1cm5zIHtQcm9taXNlPEFycmF5PE9iamVjdD4+fSBSZXNvbHZlcyB0byBhbiBhcnJheSBvZiBhbGwgcmVjb3Jkcy4NCiAgICovDQogIGdldEFsbCA9IGFzeW5jICh0YWJsZSkgPT4gew0KICAgIGNvbnN0IGRiID0gdGhpcy4jaW5NZW1vcnlTdG9yYWdlOw0KICAgIHJldHVybiBkYlt0YWJsZV0gPyBPYmplY3QudmFsdWVzKGRiW3RhYmxlXSkgOiBbXTsNCiAgfQ0KDQogIC8qKg0KICAgKiBDb3VudHMgdGhlIG51bWJlciBvZiByZWNvcmRzIGluIGEgdGFibGUgaW4gdGhlIGluLW1lbW9yeSBkYXRhYmFzZS4NCiAgICogDQogICAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZSAtIFRoZSBuYW1lIG9mIHRoZSB0YWJsZSAob2JqZWN0IHN0b3JlKS4NCiAgICogQHJldHVybnMge1Byb21pc2U8bnVtYmVyPn0gUmVzb2x2ZXMgdG8gdGhlIGNvdW50IG9mIHJlY29yZHMuDQogICAqLw0KICBjb3VudFJlY29yZHMgPSBhc3luYyAodGFibGUpID0+IHsNCiAgICBjb25zdCBkYiA9IHRoaXMuI2luTWVtb3J5U3RvcmFnZTsNCiAgICByZXR1cm4gZGJbdGFibGVdID8gT2JqZWN0LmtleXMoZGJbdGFibGVdKS5sZW5ndGggOiAwOw0KICB9DQoNCn0KCi8qIFtAc2ltcGxld2ViYXV0aG4vYnJvd3NlckA4LjAuMl0gKi8KZnVuY3Rpb24gdXRmOFN0cmluZ1RvQnVmZmVyKHZhbHVlKSB7CiAgICByZXR1cm4gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHZhbHVlKTsKfQoKZnVuY3Rpb24gYnVmZmVyVG9CYXNlNjRVUkxTdHJpbmcoYnVmZmVyKSB7CiAgICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CiAgICBsZXQgc3RyID0gJyc7CiAgICBmb3IgKGNvbnN0IGNoYXJDb2RlIG9mIGJ5dGVzKSB7CiAgICAgICAgc3RyICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoY2hhckNvZGUpOwogICAgfQogICAgY29uc3QgYmFzZTY0U3RyaW5nID0gYnRvYShzdHIpOwogICAgcmV0dXJuIGJhc2U2NFN0cmluZy5yZXBsYWNlKC9cKy9nLCAnLScpLnJlcGxhY2UoL1wvL2csICdfJykucmVwbGFjZSgvPS9nLCAnJyk7Cn0KCmZ1bmN0aW9uIGJhc2U2NFVSTFN0cmluZ1RvQnVmZmVyKGJhc2U2NFVSTFN0cmluZykgewogICAgY29uc3QgYmFzZTY0ID0gYmFzZTY0VVJMU3RyaW5nLnJlcGxhY2UoLy0vZywgJysnKS5yZXBsYWNlKC9fL2csICcvJyk7CiAgICBjb25zdCBwYWRMZW5ndGggPSAoNCAtIChiYXNlNjQubGVuZ3RoICUgNCkpICUgNDsKICAgIGNvbnN0IHBhZGRlZCA9IGJhc2U2NC5wYWRFbmQoYmFzZTY0Lmxlbmd0aCArIHBhZExlbmd0aCwgJz0nKTsKICAgIGNvbnN0IGJpbmFyeSA9IGF0b2IocGFkZGVkKTsKICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcihiaW5hcnkubGVuZ3RoKTsKICAgIGNvbnN0IGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmluYXJ5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYnl0ZXNbaV0gPSBiaW5hcnkuY2hhckNvZGVBdChpKTsKICAgIH0KICAgIHJldHVybiBidWZmZXI7Cn0KCmZ1bmN0aW9uIGJyb3dzZXJTdXBwb3J0c1dlYkF1dGhuKCkgewogICAgcmV0dXJuICh3aW5kb3c/LlB1YmxpY0tleUNyZWRlbnRpYWwgIT09IHVuZGVmaW5lZCAmJgogICAgICAgIHR5cGVvZiB3aW5kb3cuUHVibGljS2V5Q3JlZGVudGlhbCA9PT0gJ2Z1bmN0aW9uJyk7Cn0KCmZ1bmN0aW9uIHRvUHVibGljS2V5Q3JlZGVudGlhbERlc2NyaXB0b3IoZGVzY3JpcHRvcikgewogICAgY29uc3QgeyBpZCB9ID0gZGVzY3JpcHRvcjsKICAgIHJldHVybiB7CiAgICAgICAgLi4uZGVzY3JpcHRvciwKICAgICAgICBpZDogYmFzZTY0VVJMU3RyaW5nVG9CdWZmZXIoaWQpLAogICAgICAgIHRyYW5zcG9ydHM6IGRlc2NyaXB0b3IudHJhbnNwb3J0cywKICAgIH07Cn0KCmZ1bmN0aW9uIGlzVmFsaWREb21haW4oaG9zdG5hbWUpIHsKICAgIHJldHVybiAoaG9zdG5hbWUgPT09ICdsb2NhbGhvc3QnIHx8CiAgICAgICAgL14oW2EtejAtOV0rKC1bYS16MC05XSspKlwuKStbYS16XXsyLH0kL2kudGVzdChob3N0bmFtZSkpOwp9CgpjbGFzcyBXZWJBdXRobkVycm9yIGV4dGVuZHMgRXJyb3IgewogICAgY29uc3RydWN0b3IoeyBtZXNzYWdlLCBjb2RlLCBjYXVzZSwgbmFtZSwgfSkgewogICAgICAgIHN1cGVyKG1lc3NhZ2UsIHsgY2F1c2UgfSk7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZSA/PyBjYXVzZS5uYW1lOwogICAgICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgICB9Cn0KCmZ1bmN0aW9uIGlkZW50aWZ5UmVnaXN0cmF0aW9uRXJyb3IoeyBlcnJvciwgb3B0aW9ucywgfSkgewogICAgY29uc3QgeyBwdWJsaWNLZXkgfSA9IG9wdGlvbnM7CiAgICBpZiAoIXB1YmxpY0tleSkgewogICAgICAgIHRocm93IEVycm9yKCdvcHRpb25zIHdhcyBtaXNzaW5nIHJlcXVpcmVkIHB1YmxpY0tleSBwcm9wZXJ0eScpOwogICAgfQogICAgaWYgKGVycm9yLm5hbWUgPT09ICdBYm9ydEVycm9yJykgewogICAgICAgIGlmIChvcHRpb25zLnNpZ25hbCBpbnN0YW5jZW9mIEFib3J0U2lnbmFsKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnUmVnaXN0cmF0aW9uIGNlcmVtb255IHdhcyBzZW50IGFuIGFib3J0IHNpZ25hbCcsCiAgICAgICAgICAgICAgICBjb2RlOiAnRVJST1JfQ0VSRU1PTllfQUJPUlRFRCcsCiAgICAgICAgICAgICAgICBjYXVzZTogZXJyb3IsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICdDb25zdHJhaW50RXJyb3InKSB7CiAgICAgICAgaWYgKHB1YmxpY0tleS5hdXRoZW50aWNhdG9yU2VsZWN0aW9uPy5yZXF1aXJlUmVzaWRlbnRLZXkgPT09IHRydWUpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdEaXNjb3ZlcmFibGUgY3JlZGVudGlhbHMgd2VyZSByZXF1aXJlZCBidXQgbm8gYXZhaWxhYmxlIGF1dGhlbnRpY2F0b3Igc3VwcG9ydGVkIGl0JywKICAgICAgICAgICAgICAgIGNvZGU6ICdFUlJPUl9BVVRIRU5USUNBVE9SX01JU1NJTkdfRElTQ09WRVJBQkxFX0NSRURFTlRJQUxfU1VQUE9SVCcsCiAgICAgICAgICAgICAgICBjYXVzZTogZXJyb3IsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChwdWJsaWNLZXkuYXV0aGVudGljYXRvclNlbGVjdGlvbj8udXNlclZlcmlmaWNhdGlvbiA9PT0gJ3JlcXVpcmVkJykgewogICAgICAgICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgICAgICAgICAgbWVzc2FnZTogJ1VzZXIgdmVyaWZpY2F0aW9uIHdhcyByZXF1aXJlZCBidXQgbm8gYXZhaWxhYmxlIGF1dGhlbnRpY2F0b3Igc3VwcG9ydGVkIGl0JywKICAgICAgICAgICAgICAgIGNvZGU6ICdFUlJPUl9BVVRIRU5USUNBVE9SX01JU1NJTkdfVVNFUl9WRVJJRklDQVRJT05fU1VQUE9SVCcsCiAgICAgICAgICAgICAgICBjYXVzZTogZXJyb3IsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICdJbnZhbGlkU3RhdGVFcnJvcicpIHsKICAgICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgICAgICBtZXNzYWdlOiAnVGhlIGF1dGhlbnRpY2F0b3Igd2FzIHByZXZpb3VzbHkgcmVnaXN0ZXJlZCcsCiAgICAgICAgICAgIGNvZGU6ICdFUlJPUl9BVVRIRU5USUNBVE9SX1BSRVZJT1VTTFlfUkVHSVNURVJFRCcsCiAgICAgICAgICAgIGNhdXNlOiBlcnJvciwKICAgICAgICB9KTsKICAgIH0KICAgIGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICdOb3RBbGxvd2VkRXJyb3InKSB7CiAgICAgICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSwKICAgICAgICAgICAgY29kZTogJ0VSUk9SX1BBU1NUSFJPVUdIX1NFRV9DQVVTRV9QUk9QRVJUWScsCiAgICAgICAgICAgIGNhdXNlOiBlcnJvciwKICAgICAgICB9KTsKICAgIH0KICAgIGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICdOb3RTdXBwb3J0ZWRFcnJvcicpIHsKICAgICAgICBjb25zdCB2YWxpZFB1YktleUNyZWRQYXJhbXMgPSBwdWJsaWNLZXkucHViS2V5Q3JlZFBhcmFtcy5maWx0ZXIoKHBhcmFtKSA9PiBwYXJhbS50eXBlID09PSAncHVibGljLWtleScpOwogICAgICAgIGlmICh2YWxpZFB1YktleUNyZWRQYXJhbXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnTm8gZW50cnkgaW4gcHViS2V5Q3JlZFBhcmFtcyB3YXMgb2YgdHlwZSAicHVibGljLWtleSInLAogICAgICAgICAgICAgICAgY29kZTogJ0VSUk9SX01BTEZPUk1FRF9QVUJLRVlDUkVEUEFSQU1TJywKICAgICAgICAgICAgICAgIGNhdXNlOiBlcnJvciwKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgICAgIG1lc3NhZ2U6ICdObyBhdmFpbGFibGUgYXV0aGVudGljYXRvciBzdXBwb3J0ZWQgYW55IG9mIHRoZSBzcGVjaWZpZWQgcHViS2V5Q3JlZFBhcmFtcyBhbGdvcml0aG1zJywKICAgICAgICAgICAgY29kZTogJ0VSUk9SX0FVVEhFTlRJQ0FUT1JfTk9fU1VQUE9SVEVEX1BVQktFWUNSRURQQVJBTVNfQUxHJywKICAgICAgICAgICAgY2F1c2U6IGVycm9yLAogICAgICAgIH0pOwogICAgfQogICAgZWxzZSBpZiAoZXJyb3IubmFtZSA9PT0gJ1NlY3VyaXR5RXJyb3InKSB7CiAgICAgICAgY29uc3QgZWZmZWN0aXZlRG9tYWluID0gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lOwogICAgICAgIGlmICghaXNWYWxpZERvbWFpbihlZmZlY3RpdmVEb21haW4pKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgICAgICAgICBtZXNzYWdlOiBgJHt3aW5kb3cubG9jYXRpb24uaG9zdG5hbWV9IGlzIGFuIGludmFsaWQgZG9tYWluYCwKICAgICAgICAgICAgICAgIGNvZGU6ICdFUlJPUl9JTlZBTElEX0RPTUFJTicsCiAgICAgICAgICAgICAgICBjYXVzZTogZXJyb3IsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChwdWJsaWNLZXkucnAuaWQgIT09IGVmZmVjdGl2ZURvbWFpbikgewogICAgICAgICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgICAgICAgICAgbWVzc2FnZTogYFRoZSBSUCBJRCAiJHtwdWJsaWNLZXkucnAuaWR9IiBpcyBpbnZhbGlkIGZvciB0aGlzIGRvbWFpbmAsCiAgICAgICAgICAgICAgICBjb2RlOiAnRVJST1JfSU5WQUxJRF9SUF9JRCcsCiAgICAgICAgICAgICAgICBjYXVzZTogZXJyb3IsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICdUeXBlRXJyb3InKSB7CiAgICAgICAgaWYgKHB1YmxpY0tleS51c2VyLmlkLmJ5dGVMZW5ndGggPCAxIHx8IHB1YmxpY0tleS51c2VyLmlkLmJ5dGVMZW5ndGggPiA2NCkgewogICAgICAgICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgICAgICAgICAgbWVzc2FnZTogJ1VzZXIgSUQgd2FzIG5vdCBiZXR3ZWVuIDEgYW5kIDY0IGNoYXJhY3RlcnMnLAogICAgICAgICAgICAgICAgY29kZTogJ0VSUk9SX0lOVkFMSURfVVNFUl9JRF9MRU5HVEgnLAogICAgICAgICAgICAgICAgY2F1c2U6IGVycm9yLAogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIGlmIChlcnJvci5uYW1lID09PSAnVW5rbm93bkVycm9yJykgewogICAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgICAgIG1lc3NhZ2U6ICdUaGUgYXV0aGVudGljYXRvciB3YXMgdW5hYmxlIHRvIHByb2Nlc3MgdGhlIHNwZWNpZmllZCBvcHRpb25zLCBvciBjb3VsZCBub3QgY3JlYXRlIGEgbmV3IGNyZWRlbnRpYWwnLAogICAgICAgICAgICBjb2RlOiAnRVJST1JfQVVUSEVOVElDQVRPUl9HRU5FUkFMX0VSUk9SJywKICAgICAgICAgICAgY2F1c2U6IGVycm9yLAogICAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGVycm9yOwp9CgpjbGFzcyBXZWJBdXRobkFib3J0U2VydmljZSB7CiAgICBjcmVhdGVOZXdBYm9ydFNpZ25hbCgpIHsKICAgICAgICBpZiAodGhpcy5jb250cm9sbGVyKSB7CiAgICAgICAgICAgIGNvbnN0IGFib3J0RXJyb3IgPSBuZXcgRXJyb3IoJ0NhbmNlbGxpbmcgZXhpc3RpbmcgV2ViQXV0aG4gQVBJIGNhbGwgZm9yIG5ldyBvbmUnKTsKICAgICAgICAgICAgYWJvcnRFcnJvci5uYW1lID0gJ0Fib3J0RXJyb3InOwogICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXIuYWJvcnQoYWJvcnRFcnJvcik7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld0NvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgICAgdGhpcy5jb250cm9sbGVyID0gbmV3Q29udHJvbGxlcjsKICAgICAgICByZXR1cm4gbmV3Q29udHJvbGxlci5zaWduYWw7CiAgICB9Cn0KY29uc3Qgd2ViYXV0aG5BYm9ydFNlcnZpY2UgPSBuZXcgV2ViQXV0aG5BYm9ydFNlcnZpY2UoKTsKCmNvbnN0IGF0dGFjaG1lbnRzID0gWydjcm9zcy1wbGF0Zm9ybScsICdwbGF0Zm9ybSddOwpmdW5jdGlvbiB0b0F1dGhlbnRpY2F0b3JBdHRhY2htZW50KGF0dGFjaG1lbnQpIHsKICAgIGlmICghYXR0YWNobWVudCkgewogICAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChhdHRhY2htZW50cy5pbmRleE9mKGF0dGFjaG1lbnQpIDwgMCkgewogICAgICAgIHJldHVybjsKICAgIH0KICAgIHJldHVybiBhdHRhY2htZW50Owp9Cgphc3luYyBmdW5jdGlvbiBzdGFydFJlZ2lzdHJhdGlvbihjcmVhdGlvbk9wdGlvbnNKU09OKSB7CiAgICBpZiAoIWJyb3dzZXJTdXBwb3J0c1dlYkF1dGhuKCkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dlYkF1dGhuIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhpcyBicm93c2VyJyk7CiAgICB9CiAgICBjb25zdCBwdWJsaWNLZXkgPSB7CiAgICAgICAgLi4uY3JlYXRpb25PcHRpb25zSlNPTiwKICAgICAgICBjaGFsbGVuZ2U6IGJhc2U2NFVSTFN0cmluZ1RvQnVmZmVyKGNyZWF0aW9uT3B0aW9uc0pTT04uY2hhbGxlbmdlKSwKICAgICAgICB1c2VyOiB7CiAgICAgICAgICAgIC4uLmNyZWF0aW9uT3B0aW9uc0pTT04udXNlciwKICAgICAgICAgICAgaWQ6IHV0ZjhTdHJpbmdUb0J1ZmZlcihjcmVhdGlvbk9wdGlvbnNKU09OLnVzZXIuaWQpLAogICAgICAgIH0sCiAgICAgICAgZXhjbHVkZUNyZWRlbnRpYWxzOiBjcmVhdGlvbk9wdGlvbnNKU09OLmV4Y2x1ZGVDcmVkZW50aWFscz8ubWFwKHRvUHVibGljS2V5Q3JlZGVudGlhbERlc2NyaXB0b3IpLAogICAgfTsKICAgIGNvbnN0IG9wdGlvbnMgPSB7IHB1YmxpY0tleSB9OwogICAgb3B0aW9ucy5zaWduYWwgPSB3ZWJhdXRobkFib3J0U2VydmljZS5jcmVhdGVOZXdBYm9ydFNpZ25hbCgpOwogICAgbGV0IGNyZWRlbnRpYWw7CiAgICB0cnkgewogICAgICAgIGNyZWRlbnRpYWwgPSAoYXdhaXQgbmF2aWdhdG9yLmNyZWRlbnRpYWxzLmNyZWF0ZShvcHRpb25zKSk7CiAgICB9CiAgICBjYXRjaCAoZXJyKSB7CiAgICAgICAgdGhyb3cgaWRlbnRpZnlSZWdpc3RyYXRpb25FcnJvcih7IGVycm9yOiBlcnIsIG9wdGlvbnMgfSk7CiAgICB9CiAgICBpZiAoIWNyZWRlbnRpYWwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlZ2lzdHJhdGlvbiB3YXMgbm90IGNvbXBsZXRlZCcpOwogICAgfQogICAgY29uc3QgeyBpZCwgcmF3SWQsIHJlc3BvbnNlLCB0eXBlIH0gPSBjcmVkZW50aWFsOwogICAgbGV0IHRyYW5zcG9ydHMgPSB1bmRlZmluZWQ7CiAgICBpZiAodHlwZW9mIHJlc3BvbnNlLmdldFRyYW5zcG9ydHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0cmFuc3BvcnRzID0gcmVzcG9uc2UuZ2V0VHJhbnNwb3J0cygpOwogICAgfQogICAgbGV0IHJlc3BvbnNlUHVibGljS2V5QWxnb3JpdGhtID0gdW5kZWZpbmVkOwogICAgaWYgKHR5cGVvZiByZXNwb25zZS5nZXRQdWJsaWNLZXlBbGdvcml0aG0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXNwb25zZVB1YmxpY0tleUFsZ29yaXRobSA9IHJlc3BvbnNlLmdldFB1YmxpY0tleUFsZ29yaXRobSgpOwogICAgfQogICAgbGV0IHJlc3BvbnNlUHVibGljS2V5ID0gdW5kZWZpbmVkOwogICAgaWYgKHR5cGVvZiByZXNwb25zZS5nZXRQdWJsaWNLZXkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjb25zdCBfcHVibGljS2V5ID0gcmVzcG9uc2UuZ2V0UHVibGljS2V5KCk7CiAgICAgICAgaWYgKF9wdWJsaWNLZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgcmVzcG9uc2VQdWJsaWNLZXkgPSBidWZmZXJUb0Jhc2U2NFVSTFN0cmluZyhfcHVibGljS2V5KTsKICAgICAgICB9CiAgICB9CiAgICBsZXQgcmVzcG9uc2VBdXRoZW50aWNhdG9yRGF0YTsKICAgIGlmICh0eXBlb2YgcmVzcG9uc2UuZ2V0QXV0aGVudGljYXRvckRhdGEgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXNwb25zZUF1dGhlbnRpY2F0b3JEYXRhID0gYnVmZmVyVG9CYXNlNjRVUkxTdHJpbmcocmVzcG9uc2UuZ2V0QXV0aGVudGljYXRvckRhdGEoKSk7CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGlkLAogICAgICAgIHJhd0lkOiBidWZmZXJUb0Jhc2U2NFVSTFN0cmluZyhyYXdJZCksCiAgICAgICAgcmVzcG9uc2U6IHsKICAgICAgICAgICAgYXR0ZXN0YXRpb25PYmplY3Q6IGJ1ZmZlclRvQmFzZTY0VVJMU3RyaW5nKHJlc3BvbnNlLmF0dGVzdGF0aW9uT2JqZWN0KSwKICAgICAgICAgICAgY2xpZW50RGF0YUpTT046IGJ1ZmZlclRvQmFzZTY0VVJMU3RyaW5nKHJlc3BvbnNlLmNsaWVudERhdGFKU09OKSwKICAgICAgICAgICAgdHJhbnNwb3J0cywKICAgICAgICAgICAgcHVibGljS2V5QWxnb3JpdGhtOiByZXNwb25zZVB1YmxpY0tleUFsZ29yaXRobSwKICAgICAgICAgICAgcHVibGljS2V5OiByZXNwb25zZVB1YmxpY0tleSwKICAgICAgICAgICAgYXV0aGVudGljYXRvckRhdGE6IHJlc3BvbnNlQXV0aGVudGljYXRvckRhdGEsCiAgICAgICAgfSwKICAgICAgICB0eXBlLAogICAgICAgIGNsaWVudEV4dGVuc2lvblJlc3VsdHM6IGNyZWRlbnRpYWwuZ2V0Q2xpZW50RXh0ZW5zaW9uUmVzdWx0cygpLAogICAgICAgIGF1dGhlbnRpY2F0b3JBdHRhY2htZW50OiB0b0F1dGhlbnRpY2F0b3JBdHRhY2htZW50KGNyZWRlbnRpYWwuYXV0aGVudGljYXRvckF0dGFjaG1lbnQpLAogICAgfTsKfQoKZnVuY3Rpb24gYnVmZmVyVG9VVEY4U3RyaW5nKHZhbHVlKSB7CiAgICByZXR1cm4gbmV3IFRleHREZWNvZGVyKCd1dGYtOCcpLmRlY29kZSh2YWx1ZSk7Cn0KCmZ1bmN0aW9uIGJyb3dzZXJTdXBwb3J0c1dlYkF1dGhuQXV0b2ZpbGwoKSB7CiAgICBjb25zdCBnbG9iYWxQdWJsaWNLZXlDcmVkZW50aWFsID0gd2luZG93CiAgICAgICAgLlB1YmxpY0tleUNyZWRlbnRpYWw7CiAgICBpZiAoZ2xvYmFsUHVibGljS2V5Q3JlZGVudGlhbC5pc0NvbmRpdGlvbmFsTWVkaWF0aW9uQXZhaWxhYmxlID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHJlc29sdmUoZmFsc2UpKTsKICAgIH0KICAgIHJldHVybiBnbG9iYWxQdWJsaWNLZXlDcmVkZW50aWFsLmlzQ29uZGl0aW9uYWxNZWRpYXRpb25BdmFpbGFibGUoKTsKfQoKZnVuY3Rpb24gaWRlbnRpZnlBdXRoZW50aWNhdGlvbkVycm9yKHsgZXJyb3IsIG9wdGlvbnMsIH0pIHsKICAgIGNvbnN0IHsgcHVibGljS2V5IH0gPSBvcHRpb25zOwogICAgaWYgKCFwdWJsaWNLZXkpIHsKICAgICAgICB0aHJvdyBFcnJvcignb3B0aW9ucyB3YXMgbWlzc2luZyByZXF1aXJlZCBwdWJsaWNLZXkgcHJvcGVydHknKTsKICAgIH0KICAgIGlmIChlcnJvci5uYW1lID09PSAnQWJvcnRFcnJvcicpIHsKICAgICAgICBpZiAob3B0aW9ucy5zaWduYWwgaW5zdGFuY2VvZiBBYm9ydFNpZ25hbCkgewogICAgICAgICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgICAgICAgICAgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIGNlcmVtb255IHdhcyBzZW50IGFuIGFib3J0IHNpZ25hbCcsCiAgICAgICAgICAgICAgICBjb2RlOiAnRVJST1JfQ0VSRU1PTllfQUJPUlRFRCcsCiAgICAgICAgICAgICAgICBjYXVzZTogZXJyb3IsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICdOb3RBbGxvd2VkRXJyb3InKSB7CiAgICAgICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSwKICAgICAgICAgICAgY29kZTogJ0VSUk9SX1BBU1NUSFJPVUdIX1NFRV9DQVVTRV9QUk9QRVJUWScsCiAgICAgICAgICAgIGNhdXNlOiBlcnJvciwKICAgICAgICB9KTsKICAgIH0KICAgIGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICdTZWN1cml0eUVycm9yJykgewogICAgICAgIGNvbnN0IGVmZmVjdGl2ZURvbWFpbiA9IHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZTsKICAgICAgICBpZiAoIWlzVmFsaWREb21haW4oZWZmZWN0aXZlRG9tYWluKSkgewogICAgICAgICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgICAgICAgICAgbWVzc2FnZTogYCR7d2luZG93LmxvY2F0aW9uLmhvc3RuYW1lfSBpcyBhbiBpbnZhbGlkIGRvbWFpbmAsCiAgICAgICAgICAgICAgICBjb2RlOiAnRVJST1JfSU5WQUxJRF9ET01BSU4nLAogICAgICAgICAgICAgICAgY2F1c2U6IGVycm9yLAogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocHVibGljS2V5LnJwSWQgIT09IGVmZmVjdGl2ZURvbWFpbikgewogICAgICAgICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgICAgICAgICAgbWVzc2FnZTogYFRoZSBSUCBJRCAiJHtwdWJsaWNLZXkucnBJZH0iIGlzIGludmFsaWQgZm9yIHRoaXMgZG9tYWluYCwKICAgICAgICAgICAgICAgIGNvZGU6ICdFUlJPUl9JTlZBTElEX1JQX0lEJywKICAgICAgICAgICAgICAgIGNhdXNlOiBlcnJvciwKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgZWxzZSBpZiAoZXJyb3IubmFtZSA9PT0gJ1Vua25vd25FcnJvcicpIHsKICAgICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgICAgICBtZXNzYWdlOiAnVGhlIGF1dGhlbnRpY2F0b3Igd2FzIHVuYWJsZSB0byBwcm9jZXNzIHRoZSBzcGVjaWZpZWQgb3B0aW9ucywgb3IgY291bGQgbm90IGNyZWF0ZSBhIG5ldyBhc3NlcnRpb24gc2lnbmF0dXJlJywKICAgICAgICAgICAgY29kZTogJ0VSUk9SX0FVVEhFTlRJQ0FUT1JfR0VORVJBTF9FUlJPUicsCiAgICAgICAgICAgIGNhdXNlOiBlcnJvciwKICAgICAgICB9KTsKICAgIH0KICAgIHJldHVybiBlcnJvcjsKfQoKYXN5bmMgZnVuY3Rpb24gc3RhcnRBdXRoZW50aWNhdGlvbihyZXF1ZXN0T3B0aW9uc0pTT04sIHVzZUJyb3dzZXJBdXRvZmlsbCA9IGZhbHNlKSB7CiAgICBpZiAoIWJyb3dzZXJTdXBwb3J0c1dlYkF1dGhuKCkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dlYkF1dGhuIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhpcyBicm93c2VyJyk7CiAgICB9CiAgICBsZXQgYWxsb3dDcmVkZW50aWFsczsKICAgIGlmIChyZXF1ZXN0T3B0aW9uc0pTT04uYWxsb3dDcmVkZW50aWFscz8ubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgYWxsb3dDcmVkZW50aWFscyA9IHJlcXVlc3RPcHRpb25zSlNPTi5hbGxvd0NyZWRlbnRpYWxzPy5tYXAodG9QdWJsaWNLZXlDcmVkZW50aWFsRGVzY3JpcHRvcik7CiAgICB9CiAgICBjb25zdCBwdWJsaWNLZXkgPSB7CiAgICAgICAgLi4ucmVxdWVzdE9wdGlvbnNKU09OLAogICAgICAgIGNoYWxsZW5nZTogYmFzZTY0VVJMU3RyaW5nVG9CdWZmZXIocmVxdWVzdE9wdGlvbnNKU09OLmNoYWxsZW5nZSksCiAgICAgICAgYWxsb3dDcmVkZW50aWFscywKICAgIH07CiAgICBjb25zdCBvcHRpb25zID0ge307CiAgICBpZiAodXNlQnJvd3NlckF1dG9maWxsKSB7CiAgICAgICAgaWYgKCEoYXdhaXQgYnJvd3NlclN1cHBvcnRzV2ViQXV0aG5BdXRvZmlsbCgpKSkgewogICAgICAgICAgICB0aHJvdyBFcnJvcignQnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFdlYkF1dGhuIGF1dG9maWxsJyk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsaWdpYmxlSW5wdXRzID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnaW5wdXRbYXV0b2NvbXBsZXRlKj1cJ3dlYmF1dGhuXCddJyk7CiAgICAgICAgaWYgKGVsaWdpYmxlSW5wdXRzLmxlbmd0aCA8IDEpIHsKICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ05vIDxpbnB1dD4gd2l0aCBgIndlYmF1dGhuImAgaW4gaXRzIGBhdXRvY29tcGxldGVgIGF0dHJpYnV0ZSB3YXMgZGV0ZWN0ZWQnKTsKICAgICAgICB9CiAgICAgICAgb3B0aW9ucy5tZWRpYXRpb24gPSAnY29uZGl0aW9uYWwnOwogICAgICAgIHB1YmxpY0tleS5hbGxvd0NyZWRlbnRpYWxzID0gW107CiAgICB9CiAgICBvcHRpb25zLnB1YmxpY0tleSA9IHB1YmxpY0tleTsKICAgIG9wdGlvbnMuc2lnbmFsID0gd2ViYXV0aG5BYm9ydFNlcnZpY2UuY3JlYXRlTmV3QWJvcnRTaWduYWwoKTsKICAgIGxldCBjcmVkZW50aWFsOwogICAgdHJ5IHsKICAgICAgICBjcmVkZW50aWFsID0gKGF3YWl0IG5hdmlnYXRvci5jcmVkZW50aWFscy5nZXQob3B0aW9ucykpOwogICAgfQogICAgY2F0Y2ggKGVycikgewogICAgICAgIHRocm93IGlkZW50aWZ5QXV0aGVudGljYXRpb25FcnJvcih7IGVycm9yOiBlcnIsIG9wdGlvbnMgfSk7CiAgICB9CiAgICBpZiAoIWNyZWRlbnRpYWwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F1dGhlbnRpY2F0aW9uIHdhcyBub3QgY29tcGxldGVkJyk7CiAgICB9CiAgICBjb25zdCB7IGlkLCByYXdJZCwgcmVzcG9uc2UsIHR5cGUgfSA9IGNyZWRlbnRpYWw7CiAgICBsZXQgdXNlckhhbmRsZSA9IHVuZGVmaW5lZDsKICAgIGlmIChyZXNwb25zZS51c2VySGFuZGxlKSB7CiAgICAgICAgdXNlckhhbmRsZSA9IGJ1ZmZlclRvVVRGOFN0cmluZyhyZXNwb25zZS51c2VySGFuZGxlKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgaWQsCiAgICAgICAgcmF3SWQ6IGJ1ZmZlclRvQmFzZTY0VVJMU3RyaW5nKHJhd0lkKSwKICAgICAgICByZXNwb25zZTogewogICAgICAgICAgICBhdXRoZW50aWNhdG9yRGF0YTogYnVmZmVyVG9CYXNlNjRVUkxTdHJpbmcocmVzcG9uc2UuYXV0aGVudGljYXRvckRhdGEpLAogICAgICAgICAgICBjbGllbnREYXRhSlNPTjogYnVmZmVyVG9CYXNlNjRVUkxTdHJpbmcocmVzcG9uc2UuY2xpZW50RGF0YUpTT04pLAogICAgICAgICAgICBzaWduYXR1cmU6IGJ1ZmZlclRvQmFzZTY0VVJMU3RyaW5nKHJlc3BvbnNlLnNpZ25hdHVyZSksCiAgICAgICAgICAgIHVzZXJIYW5kbGUsCiAgICAgICAgfSwKICAgICAgICB0eXBlLAogICAgICAgIGNsaWVudEV4dGVuc2lvblJlc3VsdHM6IGNyZWRlbnRpYWwuZ2V0Q2xpZW50RXh0ZW5zaW9uUmVzdWx0cygpLAogICAgICAgIGF1dGhlbnRpY2F0b3JBdHRhY2htZW50OiB0b0F1dGhlbnRpY2F0b3JBdHRhY2htZW50KGNyZWRlbnRpYWwuYXV0aGVudGljYXRvckF0dGFjaG1lbnQpLAogICAgfTsKfQoKZnVuY3Rpb24gaXNTdXBwb3J0ZWRCcm93c2VyKCkgew0KICBjb25zdCB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7DQogIA0KICAvLyBDaGVjayBpZiB0aGUgYnJvd3NlciBpcyBGaXJlZm94DQogIGlmICh1c2VyQWdlbnQuaW5jbHVkZXMoJ2ZpcmVmb3gnKSkgew0KICAgICAgcmV0dXJuIGZhbHNlOw0KICB9DQogIA0KICAvLyBDaGVjayBpZiB0aGUgYnJvd3NlciBpcyBTYWZhcmkgb3IgYW55IGJyb3dzZXIgb24gaU9TDQogIGlmICh1c2VyQWdlbnQuaW5jbHVkZXMoJ3NhZmFyaScpIHx8IHVzZXJBZ2VudC5pbmNsdWRlcygnaXBob25lJykgfHwgdXNlckFnZW50LmluY2x1ZGVzKCdpcGFkJykgfHwgdXNlckFnZW50LmluY2x1ZGVzKCdpcG9kJykpIHsNCiAgICAgIC8vIEV4Y2x1ZGUgQ2hyb21lIGFuZCBDaHJvbWl1bS1iYXNlZCBicm93c2VycyBvbiBpT1MNCiAgICAgIGlmICghdXNlckFnZW50LmluY2x1ZGVzKCdjcmlvcycpICYmICF1c2VyQWdlbnQuaW5jbHVkZXMoJ2Nocm9tZScpKSB7DQogICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgfQ0KICB9DQogIA0KICByZXR1cm4gdHJ1ZTsNCn0NCg0KDQpjb25zdCBlemNyeXB0byA9IG5ldyBFWkNyeXB0bygpOw0KDQovKioNCiAqIEBjbGFzcw0KICogQGNsYXNzZGVzYyBUaGUgUGFzc0tleXMgY2xhc3MgaXMgZGVzaWduZWQgdG8gbWFuYWdlIFdlYkF1dGhuIHJlZ2lzdHJhdGlvbiBhbmQgYXV0aGVudGljYXRpb24gcHJvY2Vzc2VzLA0KICogcHJvdmlkaW5nIHV0aWxpdGllcyBmb3IgZW5jcnlwdGlvbiwgZGVjcnlwdGlvbiwgYW5kIGRhdGFiYXNlIG9wZXJhdGlvbnMuDQogKi8NCmNsYXNzIFBhc3NLZXlzIHsNCiAgI2FwaVB1YmxpY0tleSA9ICJNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUU4dWxUemZERUtDUGl6WjBQR3o3U1NzeThCVk9SeW9RY3p6MVArOWNUdzdkMkhRT0hMeTFOQ2xXbWNaZDJIMS9XR2xIS3NzcHpLbnQ2M0Y0UklYT3pQUT09IjsNCiAgI3NpZ0tleXM7DQogICNlemluZGV4ZGI7DQogICNsaXN0ZW5lcnMgPSB7fTsNCg0KICAvKioNCiAgICogQGNvbnN0cnVjdG9yDQogICAqIEB0aHJvd3MgV2lsbCB0aHJvdyBhbiBlcnJvciBpZiB0aGUgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFdlYkF1dGhuLg0KICAgKi8NCiAgY29uc3RydWN0b3IoKSB7DQoNCiAgICB0cnl7IA0KICAgICAgaWYoIWJyb3dzZXJTdXBwb3J0c1dlYkF1dGhuKCkpew0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJyb3dzZXIgRG9lcyBOb3QgU3VwcG9ydCBQYXNzIEtleXMiKTsNCiAgICAgIH0gDQogICAgfSBjYXRjaChlKSB7DQogICAgICB0aHJvdyBuZXcgRXJyb3IoIkJyb3dzZXIgRG9lcyBOb3QgU3VwcG9ydCBQYXNzIEtleXMiKTsNCiAgICB9DQogIH0NCg0KICAvKioNCiAgICogQG1ldGhvZA0KICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnQgLSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQuDQogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgd2hlbiB0aGUgZXZlbnQgaXMgZW1pdHRlZC4NCiAgICovDQogIG9uKGV2ZW50LCBjYWxsYmFjaykgew0KICAgIGlmICghdGhpcy4jbGlzdGVuZXJzW2V2ZW50XSkgew0KICAgICAgdGhpcy4jbGlzdGVuZXJzW2V2ZW50XSA9IFtdOw0KICAgIH0NCiAgICB0aGlzLiNsaXN0ZW5lcnNbZXZlbnRdLnB1c2goY2FsbGJhY2spOw0KICB9DQoNCiAgLyoqDQogICAqIEBtZXRob2QNCiAgICogQHByaXZhdGUNCiAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50IC0gVGhlIG5hbWUgb2YgdGhlIGV2ZW50Lg0KICAgKiBAcGFyYW0ge2FueX0gZGF0YSAtIFRoZSBkYXRhIHRvIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgZnVuY3Rpb25zLg0KICAgKi8NCiAgI2VtaXQoZXZlbnQsIGRhdGEpIHsNCiAgICBpZiAodGhpcy4jbGlzdGVuZXJzW2V2ZW50XSkgew0KICAgICAgdGhpcy4jbGlzdGVuZXJzW2V2ZW50XS5mb3JFYWNoKGNhbGxiYWNrID0+IGNhbGxiYWNrKGRhdGEpKTsNCiAgICB9DQogIH0NCg0KICAvKioNCiAgICogQG1ldGhvZA0KICAgKiBAYXN5bmMNCiAgICogQGRlc2NyaXB0aW9uDQogICAqIFRoaXMgbWV0aG9kIGlzIGRlc2lnbmVkIHRvIHJlZ2lzdGVyIGEgdXNlciBieSBjcmVhdGluZyBhbmQgaW5pdGlhbGl6aW5nIHRoZSBJbmRleGVkREIgaWYgaXQgZG9lcyBub3QgZXhpc3QgYW5kIHRoZW4gc3RvcmluZyB0aGUgZW5jcnlwdGVkIHJlc3VsdHMgb2YgdGhlIHJlZ2lzdHJhdGlvbiBwcm9jZXNzIGluIGl0Lg0KICAgKiBJdCBmaXJzdCB2YWxpZGF0ZXMgdGhlIHByZXNlbmNlIG9mIGFsbCByZXF1aXJlZCBwYXJhbWV0ZXJzIGFuZCB0aHJvd3MgYW4gZXJyb3IgaWYgYW55IGFyZSBtaXNzaW5nLiBJdCB0aGVuIGdlbmVyYXRlcyBzaWduYXR1cmUga2V5cyBhbmQgY29uc3RydWN0cyBhIGNoYWxsZW5nZSB1c2luZyB0aGUgcHVibGljIGtleSBmcm9tIHRoZSBzaWduYXR1cmUga2V5cy4NCiAgICogVGhlIG1ldGhvZCB0aGVuIGluaXRpYXRlcyB0aGUgcmVnaXN0cmF0aW9uIHByb2Nlc3Mgd2l0aCB0aGUgY29uc3RydWN0ZWQgb3B0aW9ucyBhbmQgZW5jcnlwdHMgdGhlIHJlc3VsdHMgdXNpbmcgdGVtcG9yYXJ5IGNyeXB0b2dyYXBoaWMga2V5cy4gVGhlIGVuY3J5cHRlZCByZXN1bHRzLCBhbG9uZyB3aXRoIHRoZSBwdWJsaWMga2V5IGFuZCBjaXBoZXIgc2lnbmF0dXJlLCBhcmUgdGhlbiBzdG9yZWQgaW4gdGhlICJwYXNza2V5cyIgb2JqZWN0IHN0b3JlIHdpdGhpbiB0aGUgSW5kZXhlZERCLg0KICAgKiANCiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHVzZXIuDQogICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VyTmFtZSAtIFRoZSBuYW1lIGFzc29jaWF0ZWQgd2l0aCB0aGUgdXNlci4NCiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJEaXNwbGF5TmFtZSAtIFRoZSBkaXNwbGF5IG5hbWUgYXNzb2NpYXRlZCB3aXRoIHRoZSB1c2VyLg0KICAgKiBAcGFyYW0ge3N0cmluZ30gcnBOYW1lIC0gVGhlIG5hbWUgb2YgdGhlIHJlbHlpbmcgcGFydHkuDQogICAqIA0KICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3Q+fSBBIHByb21pc2UgdGhhdCByZXNvbHZlcyB3aXRoIGFuIG9iamVjdCBjb250YWluaW5nOg0KICAgKiAtIGlkOiBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIHJlZ2lzdHJhdGlvbi4NCiAgICogLSBwYXlsb2FkOiBUaGUgQmFzZTY0IGVuY29kZWQgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBKU09OIHN0cmluZ2lmaWVkIGVuY3J5cHRlZCByZXN1bHRzLg0KICAgKiANCiAgICogQHRocm93cyBXaWxsIHRocm93IGFuIGVycm9yIGlmOg0KICAgKiAtIEFueSBvZiB0aGUgcGFyYW1ldGVycyBgdXNlcklkYCwgYHVzZXJOYW1lYCwgYHVzZXJEaXNwbGF5TmFtZWAsIG9yIGBycE5hbWVgIGFyZSBub3QgcHJvdmlkZWQuDQogICAqIC0gVGhlcmUgYXJlIGlzc3VlcyB3aXRoIHN0YXJ0aW5nIHRoZSBkYXRhYmFzZS4NCiAgICogLSBUaGVyZSBhcmUgaXNzdWVzIHdpdGggdGhlIGVuY3J5cHRpb24gcHJvY2Vzcy4NCiAgICogDQogICAqIEBleGFtcGxlDQogICAqIGNvbnN0IHBhc3NLZXlzID0gbmV3IFBhc3NLZXlzKCk7DQogICAqIHRyeSB7DQogICAqICAgY29uc3QgcmVnaXN0cmF0aW9uID0gYXdhaXQgcGFzc0tleXMucmVnaXN0ZXIoJ3VzZXJJZCcsICd1c2VyTmFtZScsICd1c2VyRGlzcGxheU5hbWUnLCAncnBOYW1lJyk7DQogICAqICAgY29uc29sZS5sb2coJ1JlZ2lzdHJhdGlvbiBJRDonLCByZWdpc3RyYXRpb24uaWQpOw0KICAgKiAgIGNvbnNvbGUubG9nKCdSZWdpc3RyYXRpb24gUGF5bG9hZDonLCByZWdpc3RyYXRpb24ucGF5bG9hZCk7DQogICAqIH0gY2F0Y2ggKGVycm9yKSB7DQogICAqICAgY29uc29sZS5lcnJvcignRXJyb3IgUmVnaXN0ZXJpbmcgVXNlcjonLCBlcnJvcik7DQogICAqIH0NCiAgICovDQogIGFzeW5jIHJlZ2lzdGVyKHVzZXJJZCwgdXNlck5hbWUsIHVzZXJEaXNwbGF5TmFtZSwgcnBOYW1lKSB7DQoNCiAgICAvLyBTdGFydCB8IENyZWF0ZSB0aGUgZGF0YWJhc2UgfCB0YWJsZQ0KICAgIGlmKCF0aGlzLiNlemluZGV4ZGIpew0KDQogICAgICB0aGlzLiNlemluZGV4ZGIgPSBuZXcgRVppbmRleERCKCk7DQoNCiAgICAgIHRyeXsNCiAgICAgICAgYXdhaXQgdGhpcy4jZXppbmRleGRiLnN0YXJ0KCJMVjQyNiIsInBhc3NrZXlzIik7DQogICAgICB9IGNhdGNoKGUpew0KICAgICAgICB0aGlzLiNlemluZGV4ZGIgPSBuZXcgU3ludGhFekluZGV4REIoKTsNCiAgICAgICAgYXdhaXQgdGhpcy4jZXppbmRleGRiLnN0YXJ0KCJMVjQyNiIsInBhc3NrZXlzIik7DQogICAgICB9DQogICAgfQ0KDQogICAgLy8gVmVyaWZ5IHRoZSBkZXYgc3VwcGxpZWQgYWxsIG5lY2Vzc2FyeSBmaWVsZHMNCiAgICBpZiAoIXVzZXJJZCkgew0KICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyB1c2VySWQgcHJvdmlkZWQiKTsNCiAgICB9DQogIA0KICAgIGlmICghdXNlck5hbWUpIHsNCiAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gdXNlck5hbWUgcHJvdmlkZWQiKTsNCiAgICB9DQogIA0KICAgIGlmICghdXNlckRpc3BsYXlOYW1lKSB7DQogICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vIHVzZXJEaXNwbGF5TmFtZSBwcm92aWRlZCIpOw0KICAgIH0NCiAgDQogICAgaWYgKCFycE5hbWUpIHsNCiAgICAgIHRocm93IG5ldyBFcnJvcigiTm8gcnBOYW1lIHByb3ZpZGVkIik7DQogICAgfQ0KDQogICAgdGhpcy4jc2lnS2V5cyA9IGF3YWl0IGV6Y3J5cHRvLkVjTWFrZVNpZ0tleXMoZmFsc2UpOw0KDQogICAgbGV0IHRhcmdldCA9IGJ0b2Eoe3RpbWVzdGFtcDogRGF0ZS5ub3coKS50b1N0cmluZygpLCBub25jZTogTWF0aC5yYW5kb20oKSwgcHVibGljS2V5OiB0aGlzLiNzaWdLZXlzLnB1YmxpY0tleX0pOw0KDQogICAgbGV0IHNpZ25hdHVyZSA9IGF3YWl0IGV6Y3J5cHRvLkVjU2lnbkRhdGEodGhpcy4jc2lnS2V5cy5wcml2YXRlS2V5LCB0YXJnZXQpOw0KDQogICAgbGV0IGNoYWxsZW5nZSA9IGJ0b2Eoe3NpZ25hdHVyZSwgdGFyZ2V0fSk7DQoNCiAgICBsZXQgb3B0aW9ucyA9IHsNCiAgICAgIGNoYWxsZW5nZSwNCiAgICAgIHJwOiB7IG5hbWU6IHJwTmFtZSwgaWQ6IHRvcC5sb2NhdGlvbi5ob3N0bmFtZSB9LA0KICAgICAgdXNlcjogeyBpZDogdXNlcklkLCBuYW1lOiB1c2VyTmFtZSwgZGlzcGxheU5hbWU6IHVzZXJEaXNwbGF5TmFtZSB9LA0KICAgICAgcHViS2V5Q3JlZFBhcmFtczogWw0KICAgICAgICB7IGFsZzogLTgsIHR5cGU6ICJwdWJsaWMta2V5IiB9LA0KICAgICAgICB7IGFsZzogLTcsIHR5cGU6ICJwdWJsaWMta2V5IiB9LA0KICAgICAgICB7IGFsZzogLTI1NywgdHlwZTogInB1YmxpYy1rZXkiIH0sDQogICAgICBdLA0KICAgICAgdGltZW91dDogNjAwMDAsDQogICAgICBhdHRlc3RhdGlvbjogIm5vbmUiLA0KICAgICAgZXhjbHVkZUNyZWRlbnRpYWxzOiBbXSwNCiAgICAgIGF1dGhlbnRpY2F0b3JTZWxlY3Rpb246IHsNCiAgICAgICAgcmVzaWRlbnRLZXk6ICJwcmVmZXJyZWQiLA0KICAgICAgICB1c2VyVmVyaWZpY2F0aW9uOiAicHJlZmVycmVkIiwNCiAgICAgICAgcmVxdWlyZVJlc2lkZW50S2V5OiBmYWxzZSwNCiAgICAgIH0sDQogICAgICBleHRlbnNpb25zOiB7IA0KICAgICAgICAgIGNyZWRQcm9wczogdHJ1ZSwNCiAgICAgIH0sDQogICAgfTsNCg0KICAgIGxldCByZXN1bHRzID0gYXdhaXQgc3RhcnRSZWdpc3RyYXRpb24ob3B0aW9ucyk7DQoNCiAgICBsZXQgdG1wS2V5cyA9IGF3YWl0IGV6Y3J5cHRvLkVjTWFrZUNyeXB0S2V5cyhmYWxzZSk7DQoNCiAgICBsZXQgZW5jcnlwdGVkUmVzdWx0cyA9IGF3YWl0IGV6Y3J5cHRvLkVjRW5jcnlwdCh0bXBLZXlzLnByaXZhdGVLZXksIHRoaXMuI2FwaVB1YmxpY0tleSwgYnRvYShKU09OLnN0cmluZ2lmeShyZXN1bHRzKSkpOw0KICAgIGVuY3J5cHRlZFJlc3VsdHMucHVibGljS2V5ID0gdG1wS2V5cy5wdWJsaWNLZXk7DQogICAgZW5jcnlwdGVkUmVzdWx0cy5jaXBoZXJTaWduYXR1cmUgPSBhd2FpdCBlemNyeXB0by5FY1NpZ25EYXRhKHRoaXMuI3NpZ0tleXMucHJpdmF0ZUtleSwgZW5jcnlwdGVkUmVzdWx0cy5jaXBoZXJ0ZXh0KTsNCg0KICAgIGF3YWl0IHRoaXMuI2V6aW5kZXhkYi5jcmVhdGVzKCJwYXNza2V5cyIsIHtpZDogcmVzdWx0cy5pZCwgYXV0aGVudGljYXRvcjogZW5jcnlwdGVkUmVzdWx0c30pOw0KDQogICAgcmV0dXJuIHtpZDogcmVzdWx0cy5pZCwgcGF5bG9hZDogYnRvYShKU09OLnN0cmluZ2lmeShlbmNyeXB0ZWRSZXN1bHRzKSl9DQoNCiAgfQ0KDQogIC8qKg0KICAgKiBAbWV0aG9kDQogICAqIEBhc3luYw0KICAgKiBAZGVzY3JpcHRpb24NCiAgICogVGhpcyBtZXRob2QgaXMgcmVzcG9uc2libGUgZm9yIGluaXRpYXRpbmcgdGhlIFdlYkF1dGhuIGF1dGhlbnRpY2F0aW9uIHByb2Nlc3MuIA0KICAgKiBJdCB0aGVuIGVuY3J5cHRzIHRoZSByZXN1bHRzIGFuZCByZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBwYXNza2V5LWlkIGFuZCB0aGUgcGF5bG9hZCwgd2hpY2ggaW5jbHVkZXMgdGhlIGVuY3J5cHRlZCBhdXRoZW50aWNhdGlvbiByZXN1bHRzLg0KICAgKiANCiAgICogQHBhcmFtIHtib29sZWFufSBbYXV0b0ZpbGw9ZmFsc2VdIC0gT3B0aW9uYWwgcGFyYW1ldGVyLiBJZiB0cnVlLCB0aGUgbWV0aG9kIHdpbGwgYXR0ZW1wdCB0byBhdXRvLWZpbGwgdGhlIGF1dGhlbnRpY2F0aW9uIHByb21wdC4gRGVmYXVsdCBpcyBmYWxzZS4NCiAgICogDQogICAqIEByZXR1cm5zIHtQcm9taXNlPE9iamVjdD59IEEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHdpdGggYW4gb2JqZWN0IGNvbnRhaW5pbmc6DQogICAqIC0gYGlkYCB7c3RyaW5nfTogVGhlIElEIG9idGFpbmVkIGZyb20gdGhlIGF1dGhlbnRpY2F0aW9uIHJlc3VsdHMuDQogICAqIC0gYHBheWxvYWRgIHtzdHJpbmd9OiBBIGJhc2U2NCBlbmNvZGVkIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIEpTT04gc3RyaW5naWZpZWQgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGVuY3J5cHRlZCBhdXRoZW50aWNhdGlvbiByZXN1bHRzLg0KICAgKiANCiAgICogQHRocm93cyBXaWxsIHRocm93IGFuIGVycm9yIGlmIHRoZXJlIGFyZSBpc3N1ZXMgd2l0aCBzdGFydGluZyB0aGUgZGF0YWJhc2Ugb3IgaWYgdGhlcmUgYXJlIGlzc3VlcyB3aXRoIGVuY3J5cHRpb24gcHJvY2Vzc2VzIHN1Y2ggYXMgZ2VuZXJhdGluZyBrZXlzLCBzaWduaW5nIGRhdGEsIG9yIGVuY3J5cHRpbmcgcmVzdWx0cy4NCiAgICogDQogICAqIEBleGFtcGxlDQogICAqIGNvbnN0IHBhc3NLZXlzID0gbmV3IFBhc3NLZXlzKCk7DQogICAqIHRyeSB7DQogICAqICAgY29uc3QgYXV0aGVudGljYXRpb25EYXRhID0gYXdhaXQgcGFzc0tleXMuYXV0aGVudGljYXRlKCk7DQogICAqICAgY29uc29sZS5sb2coJ0F1dGhlbnRpY2F0aW9uIERhdGE6JywgYXV0aGVudGljYXRpb25EYXRhKTsNCiAgICogfSBjYXRjaCAoZXJyb3IpIHsNCiAgICogICBjb25zb2xlLmVycm9yKCdBdXRoZW50aWNhdGlvbiBFcnJvcjonLCBlcnJvcik7DQogICAqIH0NCiAgICovDQogIGFzeW5jIGF1dGhlbnRpY2F0ZShhdXRvRmlsbCA9IGZhbHNlKSB7DQoNCiAgICAvLyBTdGFydCB8IENyZWF0ZSB0aGUgZGF0YWJhc2UgfCB0YWJsZQ0KICAgIGlmKCF0aGlzLiNlemluZGV4ZGIpew0KDQogICAgICB0aGlzLiNlemluZGV4ZGIgPSBuZXcgRVppbmRleERCKCk7DQoNCiAgICAgIHRyeXsNCiAgICAgICAgYXdhaXQgdGhpcy4jZXppbmRleGRiLnN0YXJ0KCJMVjQyNiIsInBhc3NrZXlzIik7DQogICAgICB9IGNhdGNoKGUpew0KICAgICAgICB0aGlzLiNlemluZGV4ZGIgPSBuZXcgU3ludGhFekluZGV4REIoKTsNCiAgICAgICAgYXdhaXQgdGhpcy4jZXppbmRleGRiLnN0YXJ0KCJMVjQyNiIsInBhc3NrZXlzIik7DQogICAgICB9DQogICAgfQ0KDQoNCiAgICB0aGlzLiNzaWdLZXlzID0gYXdhaXQgZXpjcnlwdG8uRWNNYWtlU2lnS2V5cyhmYWxzZSk7DQoNCiAgICBsZXQgdGFyZ2V0ID0gYnRvYSh7dGltZXN0YW1wOiBEYXRlLm5vdygpLnRvU3RyaW5nKCksIG5vbmNlOiBNYXRoLnJhbmRvbSgpLCBwdWJsaWNLZXk6IHRoaXMuI3NpZ0tleXMucHVibGljS2V5fSk7DQoNCiAgICBsZXQgc2lnbmF0dXJlID0gYXdhaXQgZXpjcnlwdG8uRWNTaWduRGF0YSh0aGlzLiNzaWdLZXlzLnByaXZhdGVLZXksIHRhcmdldCk7DQoNCiAgICBsZXQgY2hhbGxlbmdlID0gYnRvYSh7c2lnbmF0dXJlLCB0YXJnZXR9KTsNCg0KICAgIGxldCBvcHRpb25zID0gew0KICAgICAgY2hhbGxlbmdlLA0KICAgICAgYWxsb3dDcmVkZW50aWFsczogdW5kZWZpbmVkLA0KICAgICAgdGltZW91dDogNjAwMDAsDQogICAgICB1c2VyVmVyaWZpY2F0aW9uOiAncHJlZmVycmVkJywNCiAgICAgIGV4dGVuc2lvbnM6IHVuZGVmaW5lZCwNCiAgICAgIHJwSWQ6IHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZSwNCiAgICAgIG1lZGlhdGlvbjogJ2NvbmRpdGlvbmFsJywNCiAgICB9Ow0KIA0KICAgIGxldCByZXN1bHRzID0gYXdhaXQgc3RhcnRBdXRoZW50aWNhdGlvbihvcHRpb25zLCBhdXRvRmlsbCk7DQoNCiAgICBsZXQgYXV0aGVudGljYXRvciA9IGF3YWl0IHRoaXMuI2V6aW5kZXhkYi5yZWFkcygicGFzc2tleXMiLCByZXN1bHRzLmlkKTsNCg0KICAgIGxldCB0bXBLZXlzID0gYXdhaXQgZXpjcnlwdG8uRWNNYWtlQ3J5cHRLZXlzKGZhbHNlKTsNCg0KICAgIGxldCBlbmNyeXB0ZWRSZXN1bHRzID0gYXdhaXQgZXpjcnlwdG8uRWNFbmNyeXB0KHRtcEtleXMucHJpdmF0ZUtleSwgdGhpcy4jYXBpUHVibGljS2V5LCBidG9hKEpTT04uc3RyaW5naWZ5KHJlc3VsdHMpKSk7DQogICAgZW5jcnlwdGVkUmVzdWx0cy5wdWJsaWNLZXkgPSB0bXBLZXlzLnB1YmxpY0tleTsNCiAgICBlbmNyeXB0ZWRSZXN1bHRzLmNpcGhlclNpZ25hdHVyZSA9IGF3YWl0IGV6Y3J5cHRvLkVjU2lnbkRhdGEodGhpcy4jc2lnS2V5cy5wcml2YXRlS2V5LCBlbmNyeXB0ZWRSZXN1bHRzLmNpcGhlcnRleHQpOw0KDQogICAgcmV0dXJuIHtpZDogcmVzdWx0cy5pZCwgcGF5bG9hZDogYnRvYShKU09OLnN0cmluZ2lmeSh7YXV0aGVudGljYXRpb246IGVuY3J5cHRlZFJlc3VsdHMsIGF1dGhlbnRpY2F0b3J9KSl9Ow0KDQogIH0NCg0KDQogIC8qKg0KICAgKiBAbWV0aG9kDQogICAqIEBhc3luYw0KICAgKiBAZGVzY3JpcHRpb24NCiAgICogVGhpcyBtZXRob2QgaXMgZGVzaWduZWQgdG8gcGVyZm9ybSBhbiBhdXRvLWZpbGwgb3BlcmF0aW9uIGJhc2VkIG9uIFdlYkF1dGhuLg0KICAgKiBJdCBmaXJzdCBjaGVja3MgaWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgV2ViQXV0aG4gYXV0by1maWxsLiBJZiBub3QsIGl0IGVtaXRzIGFuICJhdXRvRmlsbCIgZXZlbnQgd2l0aCBhIGZhbHNlIHZhbHVlIGFuZCByZXR1cm5zIGZhbHNlLg0KICAgKiBJZiB0aGUgYnJvd3NlciBkb2VzIHN1cHBvcnQgV2ViQXV0aG4gYXV0by1maWxsLCBpdCB0aGVuIGxvb2tzIGZvciBhbGwgaW5wdXQgZWxlbWVudHMgb24gdGhlIHBhZ2Ugd2l0aCBhbiAnYXV0b2NvbXBsZXRlPSJ3ZWJhdXRobiInIGF0dHJpYnV0ZS4NCiAgICogSWYgbm8gc3VjaCBlbGVtZW50cyBhcmUgZm91bmQsIGl0IGxvZ3MgYSB3YXJuaW5nIHRvIHRoZSBjb25zb2xlLCBlbWl0cyBhbiAiYXV0b0ZpbGwiIGV2ZW50IHdpdGggYSBmYWxzZSB2YWx1ZS4NCiAgICogSWYgc3VjaCBlbGVtZW50cyBhcmUgZm91bmQsIGl0IHByb2NlZWRzIHRvIGNhbGwgdGhlIGBhdXRoZW50aWNhdGVgIG1ldGhvZCB3aXRoIGF1dG9GaWxsIHNldCB0byB0cnVlIGFuZCBlbWl0cyBhbiAiYXV0b0ZpbGwiIGV2ZW50IHdpdGggdGhlIGRhdGEgcmVjZWl2ZWQgZnJvbSB0aGUgYGF1dGhlbnRpY2F0ZWAgbWV0aG9kLg0KICAgKiANCiAgICogQHJldHVybnMge1Byb21pc2U8Ym9vbGVhbj59IEEgcHJvbWlzZSB0aGF0IHJlc29sdmVzIHdpdGggYSBib29sZWFuIHZhbHVlIGluZGljYXRpbmcgd2hldGhlciB0aGUgYXV0by1maWxsIG9wZXJhdGlvbiB3YXMgc3VjY2Vzc2Z1bCBvciBub3QuDQogICAqIC0gUmV0dXJucyBgZmFsc2VgIGlmIHRoZSBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgV2ViQXV0aG4gYXV0by1maWxsIG9yIGlmIG5vIGlucHV0IGVsZW1lbnRzIHdpdGggJ2F1dG9jb21wbGV0ZT0id2ViYXV0aG4iJyBhcmUgZm91bmQuDQogICAqIC0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF1dG8tZmlsbCBvcGVyYXRpb24gaXMgc3VjY2Vzc2Z1bC4NCiAgICogDQogICAqIEBleGFtcGxlDQogICAqIGNvbnN0IHBhc3NLZXlzID0gbmV3IFBhc3NLZXlzKCk7DQogICAqIHBhc3NLZXlzLm9uKCdhdXRvRmlsbCcsIChkYXRhKSA9PiB7DQogICAqICAgY29uc29sZS5sb2coJ0F1dG9GaWxsIERhdGE6JywgZGF0YSk7DQogICAqIH0pOw0KICAgKiBhd2FpdCBwYXNzS2V5cy5hdXRvRmlsbCgpOw0KICAgKi8NCiAgYXN5bmMgYXV0b0ZpbGwoKSB7DQoNCiAgICBpZighIGJyb3dzZXJTdXBwb3J0c1dlYkF1dGhuQXV0b2ZpbGwoKSl7DQogICAgICB0aGlzLiNlbWl0KCJhdXRvRmlsbCIsIGZhbHNlKTsNCiAgICAgIGNvbnNvbGUud2FybigiYXV0b2ZpbGwgbm90IHN1cHBvcnRlZCIpOw0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCg0KICAgIGlmKCEgaXNTdXBwb3J0ZWRCcm93c2VyKCkpew0KICAgICAgdGhpcy4jZW1pdCgiYXV0b0ZpbGwiLCBmYWxzZSk7DQogICAgICBjb25zb2xlLndhcm4oImF1dG9maWxsIG5vdCBzdXBwb3J0ZWQiKTsNCiAgICAgIHJldHVybiBmYWxzZTsNCg0KICAgIH0NCg0KICAgIGxldCBlbGVtZW50cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1thdXRvY29tcGxldGU9IndlYmF1dGhuIl0nKTsNCg0KICAgIGlmKCFlbGVtZW50cyl7DQogICAgICBjb25zb2xlLndhcm4oYG5vIGlucHV0IGVsZW1lbnRzIGZvdW5kIHdpdGggYXV0b2NvbXBsZXRlPSJ3ZWJhdXRobiIgYCk7DQogICAgICB0aGlzLiNlbWl0KCJhdXRvRmlsbCIsIGZhbHNlKTsNCiAgICB9DQoNCiAgICB0cnl7DQogICAgICBsZXQgZGF0YSA9IGF3YWl0IHRoaXMuYXV0aGVudGljYXRlKHRydWUpOw0KDQogICAgICB0aGlzLiNlbWl0KCJhdXRvRmlsbCIsIGRhdGEpOw0KDQogICAgfSBjYXRjaChlKXsNCiAgICAgIGNvbnNvbGUuZXJyb3IoZSk7DQogICAgfQ0KDQoNCiAgfQ0KDQogIC8qKg0KICAgKiBAbWV0aG9kDQogICAqIEBhc3luYw0KICAgKiBAZGVzY3JpcHRpb24NCiAgICogVGhpcyBtZXRob2QgaXMgZGVzaWduZWQgdG8gY2hlY2sgdGhlIHJlZ2lzdHJhdGlvbiBzdGF0dXMgb2YgdGhlIHVzZXIgYnkgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgSW5kZXhlZERCLiBJdCBmaXJzdCBlbnN1cmVzIHRoZSBleGlzdGVuY2Ugb2YgdGhlIEluZGV4ZWREQiBhbmQgaW5pdGlhbGl6ZXMgaXQgaWYgaXQgZG9lcyBub3QgZXhpc3QuDQogICAqIEl0IHRoZW4gY291bnRzIHRoZSBudW1iZXIgb2YgcmVjb3JkcyBwcmVzZW50IGluIHRoZSAicGFzc2tleXMiIG9iamVjdCBzdG9yZSB3aXRoaW4gdGhlIEluZGV4ZWREQi4gSWYgdGhlcmUgYXJlIG9uZSBvciBtb3JlIHJlY29yZHMgcHJlc2VudCwgaXQgaW1wbGllcyB0aGF0IHRoZSB1c2VyIGlzIHJlZ2lzdGVyZWQsIGFuZCB0aGUgbWV0aG9kIHJldHVybnMgdGhlIHN0cmluZyAicmVnaXN0ZXJlZCIuDQogICAqIElmIG5vIHJlY29yZHMgYXJlIGZvdW5kLCBpdCBpbmRpY2F0ZXMgdGhhdCB0aGUgcmVnaXN0cmF0aW9uIHN0YXR1cyBvZiB0aGUgdXNlciBpcyB1bmtub3duLCBhbmQgdGhlIG1ldGhvZCByZXR1cm5zIHRoZSBzdHJpbmcgInVua25vd24iLg0KICAgKiANCiAgICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nPn0gQSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2l0aCBhIHN0cmluZyBpbmRpY2F0aW5nIHRoZSByZWdpc3RyYXRpb24gc3RhdHVzLiBUaGUgc3RyaW5nIGNhbiBiZToNCiAgICogLSAicmVnaXN0ZXJlZCI6IElmIG9uZSBvciBtb3JlIHJlY29yZHMgYXJlIGZvdW5kIGluIHRoZSAicGFzc2tleXMiIG9iamVjdCBzdG9yZS4NCiAgICogLSAidW5rbm93biI6IElmIG5vIHJlY29yZHMgYXJlIGZvdW5kIGluIHRoZSAicGFzc2tleXMiIG9iamVjdCBzdG9yZS4NCiAgICogDQogICAqIEB0aHJvd3MgV2lsbCB0aHJvdyBhbiBlcnJvciBpZiB0aGVyZSBhcmUgaXNzdWVzIHdpdGggc3RhcnRpbmcgdGhlIGRhdGFiYXNlLg0KICAgKiANCiAgICogQGV4YW1wbGUNCiAgICogY29uc3QgcGFzc0tleXMgPSBuZXcgUGFzc0tleXMoKTsNCiAgICogdHJ5IHsNCiAgICogICBjb25zdCBzdGF0dXMgPSBhd2FpdCBwYXNzS2V5cy5SZWdpc3RyYXRpb25TdGF0dXMoKTsNCiAgICogICBjb25zb2xlLmxvZygnUmVnaXN0cmF0aW9uIFN0YXR1czonLCBzdGF0dXMpOw0KICAgKiB9IGNhdGNoIChlcnJvcikgew0KICAgKiAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIENoZWNraW5nIFJlZ2lzdHJhdGlvbiBTdGF0dXM6JywgZXJyb3IpOw0KICAgKiB9DQogICAqLw0KICBhc3luYyBSZWdpc3RyYXRpb25TdGF0dXMoKXsNCiAgICAvLyBTdGFydCB8IENyZWF0ZSB0aGUgZGF0YWJhc2UgfCB0YWJsZQ0KICAgIGlmKCF0aGlzLiNlemluZGV4ZGIpew0KDQogICAgICB0aGlzLiNlemluZGV4ZGIgPSBuZXcgRVppbmRleERCKCk7DQoNCiAgICAgIHRyeXsNCiAgICAgICAgYXdhaXQgdGhpcy4jZXppbmRleGRiLnN0YXJ0KCJMVjQyNiIsInBhc3NrZXlzIik7DQogICAgICB9IGNhdGNoKGUpew0KICAgICAgICB0aGlzLiNlemluZGV4ZGIgPSBuZXcgU3ludGhFekluZGV4REIoKTsNCiAgICAgICAgYXdhaXQgdGhpcy4jZXppbmRleGRiLnN0YXJ0KCJMVjQyNiIsInBhc3NrZXlzIik7DQogICAgICB9DQogICAgfQ0KDQogICAgbGV0IGRiUmVjb3JkQ291bnQgPSBhd2FpdCB0aGlzLiNlemluZGV4ZGIuY291bnRSZWNvcmRzKCJwYXNza2V5cyIpOw0KDQogICAgaWYoZGJSZWNvcmRDb3VudCA+IDApew0KICAgICAgcmV0dXJuICJyZWdpc3RlcmVkIjsNCiAgICB9IGVsc2Ugew0KICAgICAgcmV0dXJuICJ1bmtub3duIjsNCiAgICB9DQogIH0NCg0KfQoKZXhwb3J0IHsgUGFzc0tleXMgfTsK"
    );

    // Create a Blob from the decoded string
    const blob = new Blob([decodedString], { type: "application/javascript" });

    // Create a URL for the Blob
    const blobURL = URL.createObjectURL(blob);

    // We'll use a dynamic import
    let { PassKeys } = await import(blobURL);

    // Put a PassKeys instance on this instance
    this.manager = new PassKeys();
    
  }
}

export { PasskeyManager };
